#include <ros/ros.h>
#include <mavros_msgs/CommandBool.h>
#include <mavros_msgs/SetMode.h>
#include <mavros_msgs/State.h>
#include <cmath>
#include <algorithm>
#include "std_msgs/String.h"
#include <mavros_msgs/MPC_Inputs.h>
#include <mavros_msgs/MPC_Outputs.h>
#include <geometry_msgs/PoseStamped.h>
#include <iostream>

#include <sstream>
#include <Eigen/Dense>
#include <unsupported/Eigen/MatrixFunctions>
#include <Eigen/Core>
#include <Eigen/Cholesky>

mavros_msgs::State current_state;
void state_cb(const mavros_msgs::State::ConstPtr& msg){
    current_state = *msg;
}

//Callback function for MPC inputs topic
mavros_msgs::MPC_Inputs mpc_ins;
void mpc_inputs_cb(const mavros_msgs::MPC_Inputs::ConstPtr& msg){
    mpc_ins = *msg;
}


Eigen::Matrix<double, 10, 1> QPhild(const Eigen::Matrix<double, 10, 10> &E, Eigen::Matrix<double, 10, 1> &F, const Eigen::Matrix<double, 40, 10> &CC, Eigen::Matrix<double, 40, 1> &d)
{
    // Compute decomposition of E
    // static Eigen::LLT<Eigen::Matrix<double, 8, 8>> lltOfE(E);
    static Eigen::Matrix<double, 10, 40> CC_transd = CC.transpose();
    // Eigen::Matrix<double, 8, 1> DeltU=-lltOfE.solve(F);
    Eigen::Matrix<double, 10, 1> DeltU=-E.colPivHouseholderQr().solve(F);

    int kk=0;
    for(int i=0;i<40;i++){
        if(CC.row(i)*DeltU>d(i)){
            kk++;
        }else{
            kk+=0;
        }
    }

    if(kk==0){
        return DeltU;
    }else{

    // std::cout<<"Limiting MPC output\n";

    // Eigen::Matrix<double, 32, 32> T = CC*(lltOfE.solve(CC_transd));
    // Eigen::Matrix<double, 32, 1> K = (CC*(lltOfE.solve(F)) + d);

    Eigen::Matrix<double, 40, 40> T = CC*(E.colPivHouseholderQr().solve(CC_transd));
    Eigen::Matrix<double, 40, 1> K = (CC*(E.colPivHouseholderQr().solve(F)) + d);

    int k_row = 40;
    Eigen::Matrix<double, 40, 1> lambda;
    lambda.setZero(40, 1);
    double al = 3.0;
    int km = 0;

    do
    {
        Eigen::Matrix<double, 40, 1> lambda_p = lambda;
        // loop to determine lambda values for respective iterations
        int i = 0;
        do
        {
            // float Tii = T(i, i);
            // // T(i, i) = 0;
            // float la = -(T.col(i).dot(lambda) + K(i)) / Tii;
            // T(i, i) = Tii;

            double w= T.row(i)*lambda-T(i,i)*lambda(i);
            w = w + K(i);
            double la = -w/T(i,i);
            if (la < 0.0f) lambda(i) = 0.0f;
            else lambda(i) = la;
            i++;
        } while (i < k_row);
        // al = (lambda - lambda_p).squaredNorm();
        al = (lambda - lambda_p).transpose()*(lambda - lambda_p);

        if (al < 0.001f) break;
        km++;
    } while (km < 15);

    // DeltU = -lltOfE.solve(F) - (lltOfE.solve(CC_transd))*lambda;
    DeltU = -E.colPivHouseholderQr().solve(F) - (E.colPivHouseholderQr().solve(CC_transd))*lambda;

    return DeltU;
    }
}

//MPC inputs and outputs declaration !!!ADD Assign in callback function of own topic and find way to convert double array to float array!!!
float MPC_ref[2]={0,0};
float MPC_mo[2]={0,0};
float MPC_mv[2]={0,0};


int main(int argc, char **argv)
{
    ros::init(argc, argv, "MPC_handler");
    ros::NodeHandle nh;

    ros::Subscriber state_sub = nh.subscribe<mavros_msgs::State>
            ("mavros/state", 10, state_cb);

    //!!!Make New Subscriber(PX4->ROS) and Publisher(ROS->PX4) to your own topics!!!
    ros::Subscriber mpc_in_sub = nh.subscribe<mavros_msgs::MPC_Inputs>
            ("/mavros/mpc_inputs_topic", 1, mpc_inputs_cb);

    ros::Publisher mpc_outputs_pub = nh.advertise<mavros_msgs::MPC_Outputs>
            ("/mavros/mpc_outputs/mpc_outputs_topic", 1);        

    // Required for now to allow vehicle to go into offbaord mode(CHECK if you can make mpc outputs publish do the same)
    ros::Publisher local_pos_pub = nh.advertise<geometry_msgs::PoseStamped>
            ("mavros/setpoint_position/local", 10);

    ros::ServiceClient arming_client = nh.serviceClient<mavros_msgs::CommandBool>
            ("mavros/cmd/arming");
    ros::ServiceClient set_mode_client = nh.serviceClient<mavros_msgs::SetMode>
            ("mavros/set_mode");

    //the setpoint publishing rate MUST be faster than 2Hz
    ros::Rate rate(25.0);//50Hz corresponding to 0.02 seconds

     // wait for FCU connection
    while(ros::ok() && !current_state.connected){
        ros::spinOnce();
        rate.sleep();
    }

    // Required for now to allow vehicle to go into offbaord mode(CHECK if you can make mpc outputs publish do the same)
    geometry_msgs::PoseStamped pose;
    pose.pose.position.x = 0;
    pose.pose.position.y = 0;
    pose.pose.position.z = 2;

    //!!!Define Struct for publish topic!!!
    mavros_msgs::MPC_Outputs mpc_outs;

    //Intialise MPC Matrices

    /*
    // Old Spec version Matrices
    Eigen::Matrix<double, 9, 9> A_MPC_SCR;
    A_MPC_SCR <<0.989459348382158, 1.08932530018182, -0.0534669802732336, -0.915167116651920, 0.0149330097443802, -0.00678354890208165,	-0.0269691066461659, 0.00569259930920050, 0.0,
                -0.00501452948576442, 0.404992922572250, 0.0217994371287084, -0.169361079034500, -4.61635691296969e-05, -0.00689841336702157, 0.0210912692451728, -0.00376254327845558,	0.0,
                0.0131944808341501,	-2.31448761376451, -0.105572290198667, -3.09782685678973, 8.79842554450350e-05,	-0.0130944944373325, 0.277889989266389,	-0.0677920443851281, 0.0,
                0.000635250611053200, -0.217503188503054, 0.0397787269636846, 0.770348548943701, 3.01380271563891e-06, 0.000161013782593887, 0.0253868178030353, -0.00508926423038395, 0.0,
                0.0, 0.0, 0.0, 0.0, 0.618783391806141, 0.0,	0.0, 0.0, 0.0,
                0.00878953204147125, -1.26824305480228,	-0.189267244666154,	-2.11749664508850, 6.19194993133618e-05, 0.250283778936359,	-0.0979211392459245, -0.0461064921567351, 0.0,
                0.0121140549718515,	-2.37599969905095, -0.377080320463898, -4.36888797922385, 7.75920229873033e-05,	-0.154294368926455,	0.918921595596551, -0.0958672817451880,	0.0,
                0.00659747335644472, -1.67791709517627,	0.0207496086475130,	2.12846913946341, 3.84448722253087e-05,	0.0105455582238403,	0.00151702086634783, 0.999280304623887,	0.0,
                0.00659747335644472, -1.67791709517627,	0.0207496086475130,	2.12846913946341, 3.84448722253087e-05,	0.0105455582238403,	0.00151702086634783, -0.000719695376112890,	1.0;    

    Eigen::Matrix<double, 9, 2> B_MPC_SCR;
    B_MPC_SCR <<-0.0142664293470334, 0.00387753993050837,
                0.00945577315299458, -8.22844139166750e-06,
                0.172126720089495, 1.20552108625556e-05,
                0.0127647547447594,	3.14863547289992e-07,
                0.0, 0.381216608193859,
                0.117641599903018, 8.75855962778049e-06,
                0.242752589885874, 1.03583652690053e-05,
                -0.118212485306633,	4.84752680773277e-06,
                0.00178751469336671, 4.84752680773277e-06;

    Eigen::Matrix<double, 2, 9> C_MPC_SCR;
    C_MPC_SCR <<0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	1.0,
                1.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0;

    Eigen::Matrix<double, 40, 10> CC; 
    CC <<1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0,	0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 1.0, 0.0,	0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 1.0,	0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	1.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, 1.0,
        -1.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0,
        0.0, -1.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0,
        0.0, 0.0, -1.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, -1.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	-1.0, 0.0, 0.0,	0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, -1.0, 0.0,	0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, -1.0,	0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, -1.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	-1.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, -1.0,
        1.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0,
        0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        1.0, 0.0, 1.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0,
        0.0, 1.0, 0.0, 1.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0,
        1.0, 0.0, 1.0, 0.0,	1.0, 0.0, 0.0, 0.0,	0.0, 0.0,
        0.0, 1.0, 0.0, 1.0,	0.0, 1.0, 0.0, 0.0,	0.0, 0.0,
        1.0, 0.0, 1.0, 0.0,	1.0, 0.0, 1.0, 0.0,	0.0, 0.0,
        0.0, 1.0, 0.0, 1.0,	0.0, 1.0, 0.0, 1.0,	0.0, 0.0,
        1.0, 0.0, 1.0, 0.0,	1.0, 0.0, 1.0, 0.0,	1.0, 0.0,
        0.0, 1.0, 0.0, 1.0,	0.0, 1.0, 0.0, 1.0,	0.0, 1.0,
        -1.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0,
        0.0, -1.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0,
        -1.0, 0.0, -1.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,
        0.0, -1.0, 0.0,	-1.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,
        -1.0, 0.0, -1.0, 0.0, -1.0,	0.0, 0.0, 0.0, 0.0,	0.0,
        0.0, -1.0, 0.0,	-1.0, 0.0, -1.0, 0.0, 0.0, 0.0,	0.0,
        -1.0, 0.0, -1.0, 0.0, -1.0,	0.0, -1.0, 0.0,	0.0, 0.0,
        0.0, -1.0, 0.0, -1.0, 0.0, -1.0, 0.0, -1.0,	0.0, 0.0,
        -1.0, 0.0, -1.0, 0.0, -1.0,	0.0, -1.0, 0.0,	-1.0, 0.0,
        0.0, -1.0, 0.0,	-1.0, 0.0, -1.0, 0.0, -1.0,	0.0, -1.0;

    Eigen::Matrix<double, 10, 10> E;
    E <<214.613546236152, -4.03343882126537, 204.118627750615, -4.18811404038388, 193.653310297424,	-4.30969037391775, 183.090299077634, -4.39744338035616,	172.457613791499, -4.45101754767718,
        -4.03343882126537, 4.03187000773957, -3.82178694250918,	3.68741351001925, -3.60652928217077, 3.49212996881186, -3.38928570062074, 3.29648942420004,	-3.17178287471140, 3.10103261941658,
        204.118627750615, -3.82178694250918, 194.644198987988, -3.97833986689680, 184.737208339867,	-4.10357511136037, 174.864085371768, -4.19640912838495,	164.898133385748, -4.25621703793719,
        -4.18811404038388, 3.68741351001925, -3.97833986689680,	3.65673995700350, -3.76379639465479, 3.32493147055006, -3.54581880308887, 3.14234416785828,	-3.32602939891470, 2.95944861578146,
        193.653310297424, -3.60652928217077, 184.737208339867, -3.76379639465479, 175.833343593730,	-3.89192932982313, 166.501059917875, -3.98942226046309,	157.207367379400, -4.05528827233067,
        -4.30969037391775, 3.49212996881186, -4.10357511136037,	3.32493147055006, -3.89192932982313, 3.30643041179063, -3.67568677420855, 2.98684210356376,	-3.45618592502385, 2.81652332806211,
        183.090299077634, -3.38928570062074, 174.864085371768, -3.54581880308887, 166.501059917875,	-3.67568677420855, 158.154289959488, -3.77707809185351,	149.383682129505, -3.84858061249570,
        -4.39744338035616, 3.29648942420004, -4.19640912838495,	3.14234416785828, -3.98942226046309, 2.98684210356376, -3.77707809185351, 2.98008458937229,	-3.56031450227224, 2.67228773602056,
        172.457613791499, -3.17178287471140, 164.898133385748, -3.32602939891470, 157.207367379400,	-3.45618592502385, 149.383682129505, -3.56031450227224,	141.580689780040, -3.63669431826971,
        -4.45101754767718, 3.10103261941658, -4.25621703793719,	2.95944861578146, -4.05528827233067, 2.81652332806211, -3.84858061249570, 2.67228773602056,	-3.63669431826971, 2.67684412812627;// Works (W = 7.5e-2*I)                

    // E <<214.478546236152, -4.03343882126537, 204.118627750615, -4.18811404038388, 193.653310297424,	-4.30969037391775, 183.090299077634, -4.39744338035616,	172.457613791499, -4.45101754767718,
    //     -4.03343882126537, 3.89687000773957, -3.82178694250918,	3.68741351001925, -3.60652928217077, 3.49212996881186, -3.38928570062074, 3.29648942420004,	-3.17178287471140, 3.10103261941658,
    //     204.118627750615, -3.82178694250918, 194.509198987988, -3.97833986689680, 184.737208339867,	-4.10357511136037, 174.864085371768, -4.19640912838495,	164.898133385748, -4.25621703793719,
    //     -4.18811404038388, 3.68741351001925, -3.97833986689680,	3.52173995700350, -3.76379639465479, 3.32493147055006, -3.54581880308887, 3.14234416785828,	-3.32602939891470, 2.95944861578146,
    //     193.653310297424, -3.60652928217077, 184.737208339867, -3.76379639465479, 175.698343593730,	-3.89192932982313, 166.501059917875, -3.98942226046309,	157.207367379400, -4.05528827233067,
    //     -4.30969037391775, 3.49212996881186, -4.10357511136037,	3.32493147055006, -3.89192932982313, 3.17143041179063, -3.67568677420855, 2.98684210356376,	-3.45618592502385, 2.81652332806211,
    //     183.090299077634, -3.38928570062074, 174.864085371768, -3.54581880308887, 166.501059917875,	-3.67568677420855, 158.019289959488, -3.77707809185351,	149.383682129505, -3.84858061249570,
    //     -4.39744338035616, 3.29648942420004, -4.19640912838495,	3.14234416785828, -3.98942226046309, 2.98684210356376, -3.77707809185351, 2.84508458937229,	-3.56031450227224, 2.67228773602056,
    //     172.457613791499, -3.17178287471140, 164.898133385748, -3.32602939891470, 157.207367379400,	-3.45618592502385, 149.383682129505, -3.56031450227224,	141.445689780040, -3.63669431826971,
    //     -4.45101754767718, 3.10103261941658, -4.25621703793719,	2.95944861578146, -4.05528827233067, 2.81652332806211, -3.84858061249570, 2.67228773602056,	-3.63669431826971, 2.54184412812627; // Works (W = 7.5e-3*I)   

    Eigen::Matrix<double, 60, 10> H;
    H <<0.00178751469336671, 4.84752680773277e-06, 0.0, 0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0,
        -0.0142664293470334, 0.00387753993050837, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        0.0200497862689968,	6.47643935307054e-05, 0.00178751469336671, 4.84752680773277e-06, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        -0.0469848323895258, 0.0133967120555310, -0.0142664293470334, 0.00387753993050837, 0.0,	0.0, 0.0, 0.0, 0.0, 0.0,
        0.0658744075310616,	0.000280216191404071, 0.0200497862689968, 6.47643935307054e-05,	0.00178751469336671, 4.84752680773277e-06, 0.0,	0.0, 0.0, 0.0,
        -0.0896032098140003, 0.0262803720814319, -0.0469848323895258, 0.0133967120555310, -0.0142664293470334, 0.00387753993050837,	0.0, 0.0, 0.0, 0.0,
        0.139308367597775, 0.000770594755138719, 0.0658744075310616, 0.000280216191404071, 0.0200497862689968, 6.47643935307054e-05, 0.00178751469336671, 4.84752680773277e-06,	0.0, 0.0,
        -0.139385870708359,	0.0410865101071524,	-0.0896032098140003, 0.0262803720814319, -0.0469848323895258, 0.0133967120555310, -0.0142664293470334, 0.00387753993050837,	0.0, 0.0,
        0.234474231167917, 0.00165740202201784,	0.139308367597775, 0.000770594755138719, 0.0658744075310616, 0.000280216191404071, 0.0200497862689968, 6.47643935307054e-05, 0.00178751469336671, 4.84752680773277e-06,
        -0.195148039669943,	0.0569039155923665,	-0.139385870708359,	0.0410865101071524,	-0.0896032098140003, 0.0262803720814319, -0.0469848323895258, 0.0133967120555310, -0.0142664293470334, 0.00387753993050837,
        0.344354861689440, 0.00305176870320054,	0.234474231167917, 0.00165740202201784,	0.139308367597775, 0.000770594755138719, 0.0658744075310616, 0.000280216191404071, 0.0200497862689968, 6.47643935307054e-05,
        -0.255500401241304,	0.0731592730430040,	-0.195148039669943,	0.0569039155923665,	-0.139385870708359,	0.0410865101071524,	-0.0896032098140003, 0.0262803720814319, -0.0469848323895258, 0.0133967120555310,
        0.463052231660887, 0.00504456417398386,	0.344354861689440, 0.00305176870320054,	0.234474231167917, 0.00165740202201784, 0.139308367597775, 0.000770594755138719, 0.0658744075310616, 0.000280216191404071,
        -0.318753651068177,	0.0894947200785537,	-0.255500401241304,	0.0731592730430040,	-0.195148039669943,	0.0569039155923665,	-0.139385870708359,	0.0410865101071524,	-0.0896032098140003, 0.0262803720814319,
        0.586241103297265, 0.00770068013322051,	0.463052231660887, 0.00504456417398386,	0.344354861689440, 0.00305176870320054,	0.234474231167917, 0.00165740202201784,	0.139308367597775, 0.000770594755138719,
        -0.383282456554199,	0.105690481268381, -0.318753651068177, 0.0894947200785537, -0.255500401241304, 0.0731592730430040, -0.195148039669943, 0.0569039155923665, -0.139385870708359, 0.0410865101071524,
        0.710908589911458, 0.0110578020749832, 0.586241103297265, 0.00770068013322051, 0.463052231660887, 0.00504456417398386, 0.344354861689440, 0.00305176870320054, 0.234474231167917, 0.00165740202201784,
        -0.447782997872947, 0.121615993443032, -0.383282456554199, 0.105690481268381, -0.318753651068177, 0.0894947200785537, -0.255500401241304, 0.0731592730430040, -0.195148039669943, 0.0569039155923665,
        0.834997346860234, 0.0151285802474214, 0.710908589911458, 0.0110578020749832, 0.586241103297265, 0.00770068013322051, 0.463052231660887, 0.00504456417398386, 0.344354861689440, 0.00305176870320054,
        -0.511335966187406,	0.137198756920730, -0.447782997872947, 0.121615993443032, -0.383282456554199, 0.105690481268381, -0.318753651068177, 0.0894947200785537, -0.255500401241304, 0.0731592730430040,
        0.957141577860879, 0.0199046964436479, 0.834997346860234, 0.0151285802474214, 0.710908589911458, 0.0110578020749832, 0.586241103297265, 0.00770068013322051, 0.463052231660887, 0.00504456417398386,
        -0.573356298874939,	0.152404156705973, -0.511335966187406, 0.137198756920730, -0.447782997872947, 0.121615993443032, -0.383282456554199, 0.105690481268381,	-0.318753651068177,	0.0894947200785537,
        1.07649240766718, 0.0253615859834708, 0.957141577860879, 0.0199046964436479, 0.834997346860234,	0.0151285802474214,	0.710908589911458, 0.0110578020749832, 0.586241103297265, 0.00770068013322051,
        -0.633511331138014,	0.167222144931454, -0.573356298874939, 0.152404156705973, -0.511335966187406, 0.137198756920730, -0.447782997872947, 0.121615993443032,	-0.383282456554199,	0.105690481268381,
        1.19259166936504, 0.0314630280087170, 1.07649240766718,	0.0253615859834708,	0.957141577860879, 0.0199046964436479, 0.834997346860234, 0.0151285802474214, 0.710908589911458, 0.0110578020749832,
        -0.691647212044974,	0.181658315021713, -0.633511331138014, 0.167222144931454, -0.573356298874939, 0.152404156705973, -0.511335966187406, 0.137198756920730,	-0.447782997872947,	0.121615993443032,
        1.30526910372525, 0.0381651981360668, 1.19259166936504,	0.0314630280087170,	1.07649240766718, 0.0253615859834708, 0.957141577860879, 0.0199046964436479, 0.834997346860234,	0.0151285802474214,
        -0.747733026728655,	0.195727864492698, -0.691647212044974, 0.181658315021713, -0.633511331138014, 0.167222144931454, -0.573356298874939, 0.152404156705973,	-0.511335966187406,	0.137198756920730,
        1.41455567678456, 0.0454200239809410, 1.30526910372525,	0.0381651981360668,	1.19259166936504, 0.0314630280087170, 1.07649240766718,	0.0253615859834708,	0.957141577860879, 0.0199046964436479,
        -0.801820000677405,	0.209451503443468, -0.747733026728655, 0.195727864492698, -0.691647212044974, 0.181658315021713, -0.633511331138014, 0.167222144931454, -0.573356298874939,	0.152404156705973,
        1.52061301006501, 0.0531778231785487, 1.41455567678456,	0.0454200239809410,	1.30526910372525, 0.0381651981360668, 1.19259166936504,	0.0314630280087170,	1.07649240766718, 0.0253615859834708,
        -0.854011444856985,	0.222852696169656, -0.801820000677405, 0.209451503443468, -0.747733026728655, 0.195727864492698, -0.691647212044974, 0.181658315021713,	-0.633511331138014,	0.167222144931454,
        1.62367921353861, 0.0613892762057394, 1.52061301006501,	0.0531778231785487,	1.41455567678456, 0.0454200239809410, 1.30526910372525,	0.0381651981360668,	1.19259166936504, 0.0314630280087170,
        -0.904440478810176, 0.235955826017014, -0.854011444856985, 0.222852696169656, -0.801820000677405, 0.209451503443468, -0.747733026728655, 0.195727864492698,	-0.691647212044974,	0.181658315021713,
        1.72402971455921, 0.0700068212939786, 1.62367921353861,	0.0613892762057394,	1.52061301006501, 0.0531778231785487, 1.41455567678456,	0.0454200239809410,	1.30526910372525, 0.0381651981360668,
        -0.953253825831504,	0.248785003206647, -0.904440478810176, 0.235955826017014, -0.854011444856985, 0.222852696169656, -0.801820000677405, 0.209451503443468,	-0.747733026728655, 0.195727864492698,
        1.82195047448234, 0.0789855718511547, 1.72402971455921,	0.0700068212939786,	1.62367921353861, 0.0613892762057394, 1.52061301006501,	0.0531778231785487,	1.41455567678456, 0.0454200239809410,
        -1.00060052581532, 0.261363320874410, -0.953253825831504, 0.248785003206647, -0.904440478810176, 0.235955826017014,	-0.854011444856985,	0.222852696169656, -0.801820000677405, 0.209451503443468,
        1.91772071569483, 0.0882838565546395, 1.82195047448234,	0.0789855718511547,	1.72402971455921, 0.0700068212939786, 1.62367921353861,	0.0613892762057394,	1.52061301006501, 0.0531778231785487,
        -1.04662456213395, 0.273712422218844, -1.00060052581532, 0.261363320874410, -0.953253825831504,	0.248785003206647, -0.904440478810176, 0.235955826017014, -0.854011444856985, 0.222852696169656,
        2.01160259397494, 0.0978634739002926, 1.91772071569483,	0.0882838565546395,	1.82195047448234, 0.0789855718511547, 1.72402971455921,	0.0700068212939786,	1.62367921353861, 0.0613892762057394,
        -1.09146046457240, 0.285852281254264, -1.04662456213395, 0.273712422218844,	-1.00060052581532, 0.261363320874410, -0.953253825831504, 0.248785003206647, -0.904440478810176, 0.235955826017014,
        2.10383575652845, 0.107689740289476, 2.01160259397494, 0.0978634739002926, 1.91772071569483, 0.0882838565546395, 1.82195047448234, 0.0789855718511547, 1.72402971455921, 0.0700068212939786,
        -1.13523105742709, 0.297801127412704, -1.09146046457240, 0.285852281254264, -1.04662456213395, 0.273712422218844, -1.00060052581532, 0.261363320874410, -0.953253825831504,	0.248785003206647,
        2.19463521447100, 0.117731396496678, 2.10383575652845, 0.107689740289476, 2.01160259397494,	0.0978634739002926,	1.91772071569483, 0.0882838565546395, 1.82195047448234,	0.0789855718511547,
        -1.17804667214869, 0.309575464072378, -1.13523105742709, 0.297801127412704,	-1.09146046457240, 0.285852281254264, -1.04662456213395, 0.273712422218844,	-1.00060052581532, 0.261363320874410,
        2.28419136317480, 0.127960423459704, 2.19463521447100, 0.117731396496678, 2.10383575652845,	0.107689740289476, 2.01160259397494, 0.0978634739002926, 1.91772071569483, 0.0882838565546395,
        -1.22000530309032, 0.321190145503729, -1.17804667214869, 0.309575464072378,	-1.13523105742709, 0.297801127412704, -1.09146046457240, 0.285852281254264,	-1.04662456213395, 0.273712422218844,
        2.37267130323963, 0.138351805860675, 2.28419136317480, 0.127960423459704, 2.19463521447100, 0.117731396496678, 2.10383575652845, 0.107689740289476,	2.01160259397494, 0.0978634739002926,
        -1.26119332670294, 0.332658487300700, -1.22000530309032, 0.321190145503729,	-1.17804667214869, 0.309575464072378, -1.13523105742709, 0.297801127412704, -1.09146046457240, 0.285852281254264,
        2.46022086362060, 0.148883271413077, 2.37267130323963, 0.138351805860675, 2.28419136317480,	0.127960423459704, 2.19463521447100, 0.117731396496678,	2.10383575652845, 0.107689740289476,
        -1.30168651873491, 0.343992393140419, -1.26119332670294, 0.332658487300700,	-1.22000530309032, 0.321190145503729, -1.17804667214869, 0.309575464072378,	-1.13523105742709, 0.297801127412704,
        2.54696692003485, 0.159535025239176, 2.46022086362060, 0.148883271413077, 2.37267130323963,	0.138351805860675, 2.28419136317480, 0.127960423459704,	2.19463521447100, 0.117731396496678,
        -1.34155119096213, 0.355202486400283, -1.30168651873491, 0.343992393140419,	-1.26119332670294, 0.332658487300700, -1.22000530309032, 0.321190145503729,	-1.17804667214869, 0.309575464072378,
        2.63301974609496, 0.170289492086901, 2.54696692003485, 0.159535025239176, 2.46022086362060,	0.148883271413077, 2.37267130323963, 0.138351805860675,	2.28419136317480, 0.127960423459704,
        -1.38084533304610, 0.366298239272258, -1.34155119096213, 0.355202486400283,	-1.30168651873491, 0.343992393140419, -1.26119332670294, 0.332658487300700, -1.22000530309032, 0.321190145503729,
        2.71847523985527, 0.181131074156295, 2.63301974609496, 0.170289492086901, 2.54696692003485,	0.159535025239176, 2.46022086362060, 0.148883271413077,	2.37267130323963, 0.138351805860675,
        -1.41961969112254, 0.377288094937307, -1.38084533304610, 0.366298239272258,	-1.34155119096213, 0.355202486400283, -1.30168651873491, 0.343992393140419,	-1.26119332670294, 0.332658487300700,
        2.80341694219203, 0.192045928703275, 2.71847523985527, 0.181131074156295, 2.63301974609496,	0.170289492086901, 2.54696692003485, 0.159535025239176, 2.46022086362060, 0.148883271413077,
        -1.45791874681429, 0.388179580396150, -1.41961969112254, 0.377288094937307,	-1.38084533304610, 0.366298239272258, -1.34155119096213, 0.355202486400283, -1.30168651873491, 0.343992393140419;

    Eigen::Matrix<double, 60, 11> P; 
    P <<0.00659747335644472, -1.67791709517627,	0.0207496086475130,	2.12846913946341, 3.84448722253087e-05,	0.0105455582238403,	0.00151702086634783, -0.000719695376112890,	1.0, 1.0, 0.0,
        0.989459348382158, 1.08932530018182, -0.0534669802732336, -0.915167116651920, 0.0149330097443802, -0.00678354890208165,	-0.0269691066461659, 0.00569259930920050, 0.0, 0.0,	1.0,
        0.0298690544096266,	-4.55493666350963, 0.0844631302771181, 6.07996902836380, 0.000285641009367549, 0.0350900599114652, 0.0276281776788817, -0.00867842731806861, 2.0, 1.0, 0.0,
        1.96139109444050, 2.99426793666123, -0.101811714447942,	-2.40023762689365, 0.0388888709553082, -0.0179340417595238,	-0.0928794134395733, 0.0240954474587663, 0.0, 0.0, 1.0,
        0.0777501093574156,	-8.45941838393868, 0.177053709186326, 11.3380651332834,	0.000978129640300466, 0.0671569309651226, 0.107437554775779, -0.0344581037770990, 3.0, 1.0,	0.0,
        2.91116934353680, 5.39927287365976,	-0.138875888182067,	-4.25586326502437, 0.0681244609559112, -0.0297014669931225,	-0.189496236254741,	0.0585184966921654,	0.0, 0.0, 1.0,
        0.156943559481977, -13.2114567965876, 0.272814456450246, 17.3762684997200, 0.00237150846500650,	0.0993864328386645,	0.254688541214880, -0.0881419170254531,	4.0, 1.0, 0.0,
        3.83616176646096, 8.08401586666268,	-0.167757629612522,	-6.32674948559936, 0.100271227243624, -0.0402232507653700, -0.309373278123578, 0.111035915829931, 0.0, 0.0,	1.0,
        0.272541166111351, -18.5632800896972, 0.353081073230071, 23.7661104713552, 0.00471210128957987,	0.126674996836455, 0.465819708011390, -0.177000593206827, 5.0, 1.0,	0.0,
        4.73504663592786, 10.9062583345599,	-0.189731982830564,	-8.47600575024760, 0.133835379507651, -0.0485569522499384, -0.447341645608407, 0.183154336102157, 0.0, 0.0,	1.0,
        0.427684140577343, -24.2454700658103, 0.410067117983021, 30.1996076504584, 0.00821312112913297,	0.146649754679166, 0.727071522800270, -0.305180279217158, 6.0, 1.0,	0.0,
        5.60738039216405, 13.7641272773160,	-0.204345258565091,	-10.5903005982316, 0.167880231706856, -0.0542194128269915, -0.598584983431763, 0.275757744498022, 0.0, 0.0,	1.0,
        0.623616299380091, -30.0178245580198, 0.443600173849414, 36.4714362817230, 0.0130379838498610, 0.158968614144704, 1.02164128183723,	-0.474296192681190,	7.0, 1.0, 0.0,
        6.45338140045306, 16.5766419796309,	-0.211223487364277,	-12.5862591659075, 0.201825076303137, -0.0571054420229899, -0.757856876742855, 0.389018730458836, 0.0, 0.0, 1.0,
        0.860013928480228, -35.6935835634292, 0.457067895225163, 42.4528359963015, 0.0192932728002531, 0.164425230726033, 1.33389185979831,	-0.684175841717404,	8.0, 1.0, 0.0,
        7.27379532140369, 19.2793553714553,	-0.210861261188179,	-14.4100734880141, 0.235318284733456, -0.0574306998666541, -0.919839650532106, 0.522458217366857, 0.0, 0.0,	1.0,
        1.13540180056723, -41.1414402959806, 0.454829105453577,	48.0697918706148, 0.0270302369128806, 0.164281539339904, 1.65099682555728, -0.933463258403136, 9.0,	1.0, 0.0,
        8.06977014562922, 21.8248630014175,	-0.204485044414630,	-16.0323234619145, 0.268156884634675, -0.0556200374450838, -1.07977719693936, 0.675104041757111, 0.0, 0.0, 1.0,
        1.44753694851083, -46.2772134452872, 0.441046591730765,	53.2871467899083, 0.0362517924834695, 0.159881932138572, 1.96318966381840, -1.22005325639108, 10.0,	1.0, 0.0,
        8.84272944845765, 24.1825261212079,	-0.193623028402015,	-17.4415166158087, 0.300234897504768, -0.0521838557375783, -1.23388361834671, 0.845666687289234, 0.0, 0.0, 1.0,
        1.79371790347562, -51.0532735388855, 0.419309396784632,	58.0970204696455, 0.0469220303847808, 0.152466334776217, 2.26346751308813, -1.54140064450403, 11.0, 1.0, 0.0,
        9.59425544445679, 26.3363400443448,	-0.179758486591733,	-18.6383835523110, 0.331509531020667, -0.0476240779857997, -1.37944946328945, 1.03268664921815,	0.0, 0.0, 1.0,
        2.17101803922203, -55.4490709138831, 0.392566660204023,	62.5100163675717, 0.0589761141269408, 0.143093915309728, 2.54715246481084, -1.89474567667848, 12.0,	1.0, 0.0,
        10.3259926731853, 28.2817862916028,	-0.164154345593201,	-19.6315105655172, 0.361978662398478, -0.0423807928395564, -1.51474898808928, 1.23464236497850,	0.0, 0.0, 1.0,
        2.57645502788770, -59.4634623814826, 0.363154020658882,	66.5484334651463, 0.0723293721303289, 0.132621826988125, 2.81144743082878, -2.27727884028031, 13.0,	1.0, 0.0,
        11.0395758787331, 30.0226277525145, -0.147804277509162,	-20.4341858342009, 0.391665655771711, -0.0368112962108439, -1.63886416944238, 1.45002389262947,	0.0, 0.0, 1.0,
        3.00710941329761, -63.1086449171572, 0.332847093610936,	70.2411351695213, 0.0868850398812989, 0.121711155210694, 3.05502212790094, -2.68625711738362, 14.0,	1.0, 0.0,
        11.7365801712096, 31.5681646741925,	-0.131447215704680,	-21.0621690474437, 0.420609070001884, -0.0311887577577216, -1.75149691927515, 1.67738098021552,	0.0, 0.0, 1.0,
        3.46020323065620, -66.4054061912604, 0.302930198534726,	73.6198437398157, 0.102540494278803, 0.110846881469725,	3.27764121826033, -3.11908040764428, 15.0, 1.0,	0.0,
        12.4184893025030, 32.9310890238311,	-0.115604319128380,	-21.5321388542001, 0.448855694423004, -0.0257105377959027, -1.85280052483456, 1.91535271043595,	0.0, 0.0, 1.0,
        3.93314770058464, -69.3794820692801, 0.274275889036574,	76.7166161482643, 0.119192030444520, 0.100364656177429,	3.47984360703077, -3.57333639053426, 16.0, 1.0,	0.0,
        13.0866776987515, 34.1258891397538,	-0.100619760305436,	-21.8606456393579, 0.476455879918219, -0.0205102134036538, -1.94323915231758, 2.16268384507071,	0.0, 0.0, 1.0,
        4.42356765524173, -72.0588612242275, 0.247427936575481,	79.5622416316842, 0.136738336037578, 0.0904796101439839, 3.66267861146301, -4.04682182386485, 17.0,	1.0, 0.0,
        13.7424025133114, 35.1677046907518,	-0.0866989421885587, -22.0634453679068,	0.503460465557839, -0.0156702638227347,	-2.02347545157511, 2.41823157890923, 0.0, 0.0, 1.0,
        4.92930918451036, -74.4718843838526, 0.222679868644736,	82.1853176362309, 0.155082864395402, 0.0813139443796686, 3.82749923725653, -4.53754733545587, 18.0,	1.0, 0.0,
        14.3868027188782, 36.0715355516768,	-0.0739423420066371, -22.1551166310227,	0.529918817880386, -0.0112339555823110,	-2.09428366577246, 2.68096556224742, 0.0, 0.0, 1.0,
        5.44843582609764, -76.6459827758763, 0.200143576257020,	84.6118002963725, 0.174135319038128, 0.0729213398933292, 3.97580775604369, -5.04373139502881, 19.0,	1.0, 0.0,
        15.0209029212933, 36.8517240362086,	-0.0623744171037557, -22.1488803787132,	0.555877644779401, -0.00721575511476356, -2.15648496635970,	2.94996345827091, 0.0, 0.0, 1.0,
        5.97921747301004, -78.6069065407454, 0.179805629205937,	86.8648712389742, 0.193812451566980, 0.0653073095223131, 4.10914578608047, -5.56378774347478, 20.0, 1.0, 0.0,
        15.6456201251493, 37.5216440687270,	-0.0519673787501917, -22.0565572280553,	0.581380344611871, -0.00361000573021317, -2.21090149755554,	3.22440379645398, 0.0, 0.0,	1.0,
        6.52011511749144, -80.3783114335337, 0.161571302933746,	88.9650038823867, 0.214038351894560, 0.0584453778138962, 4.22902015215173, -6.09630933798875, 21.0, 1.0, 0.0,
        16.2617721334681, 38.0935422152865,	-0.0426599566204128, -21.8886120903391,	0.606466719607827, -0.000397848858653509, -2.25832556893161, 3.50355742796007, 0.0,	0.0, 1.0,
        7.06976365630066, -81.9815956817680, 0.145297620750190,	90.9301459086843, 0.234744380876173, 0.0522894258483904, 4.33685624281283, -6.64005091113037, 22.0,	1.0, 0.0,
        16.8700866360535, 38.5784855055020,	-0.0343715917385944, -21.6542493097183,	0.631172931151888, 0.00244747833727423,	-2.29950060783143, 3.78677849802829, 0.0, 0.0, 1.0,
        7.62695426958023, -83.4359029062541, 0.130817213248859,	92.7759603372907, 0.255868865595952, 0.0467827495160160, 4.43397168608390, -7.19391152045998, 23.0,	1.0, 0.0,
        17.4712103406101, 38.9863803525110,	-0.0270127130944634, -21.3615326803326,	0.655531609504773, 0.00495675174573838,	-2.33511085603605, 4.07349553748486, 0.0, 0.0, 1.0,
        8.19061734391699, -84.7582283775592, 0.117954841522988,	94.5160869139442, 0.277356649828287, 0.0418644384446916, 4.52156446296000, -7.75691793842576, 24.0,	1.0, 0.0,
        18.0657177327446, 39.3260354533855,	-0.0204918361669926, -21.0175133628695,	0.679572056128974, 0.00716202548944510,	-2.36577728412325, 4.36320304058794, 0.0, 0.0, 1.0,
        8.75980651395275, -85.9635834653159, 0.106538266705512,	96.1623996867088, 0.299158568118720, 0.0374736562910061, 4.60071083216093, -8.32820935662709, 25.0,	1.0, 0.0,
        18.6541192231848, 39.6052489501574,	-0.0147201968122861, -20.6283550896926,	0.703320495607800, 0.00909480725610269,	-2.39205771166720, 4.65545372877357, 0.0, 0.0, 1.0,
        9.33368411728114, -87.0651869665570, 0.0964049066349515, 97.7252467727689, 0.321230892063399, 0.0335523353650668, 4.67236954872261,	-8.90702361932476, 26.0, 1.0, 0.0,
        19.2368685628382, 39.8309061424916,	-0.00961454794903990, -20.1994505567071, 0.726800347962760,	0.0107849225550761,	-2.41444959841230, 4.94985158539615, 0.0, 0.0, 1.0,
        9.91150816783700, -88.0746625333377, 0.0874054624438335, 99.2136653211437, 0.343534781637958, 0.0300467152912582, 4.73738979122285,	-9.49268502994724, 27.0, 1.0, 0.0,
        19.8143694891207, 40.0090786858887,	-0.00509863767650867, -19.7355259828405, 0.750032502225890,	0.0122598811867679,	-2.43339437957941, 5.24604567193397, 0.0, 0.0, 1.0,
        10.4926208310087, -89.0022292146661, 0.0794054519083479, 100.635569294645, 0.366035762422477, 0.0269080709985892, 4.79652096643947,	-10.0845936684576, 28.0, 1.0, 0.0,
        20.3869816199884, 40.1451196494266,	-0.00110377900944006, -19.2407328411989, 0.773035579333593,	0.0135445955057451,	-2.44928254923353, 5.54372469040190, 0.0, 0.0, 1.0,
        11.0764383108801, -89.8568777147870, 0.0722853665225490, 101.997910555652, 0.388703240729187, 0.0240928975493405, 4.85042314931619,	-10.6822160982247, 29.0, 1.0, 0.0,
        20.9550256434514, 40.2437512636660,	0.00243117572438742, -18.7187270206915,	0.795826177480900, 0.0146613338595454, -2.46245895331519, 5.84261223135703,	0.0, 0.0, 1.0,
        11.6624420217280, -90.6465288257022, 0.0659399822111488, 103.306815355600, 0.411510062372418, 0.0215627519550753, 4.89967736079766,	-11.2850773138011, 30.0, 1.0, 0.0,
        21.5187878665428, 40.3091438783936,	0.00556022472836629, -18.1727363889568,	0.818419096554322, 0.0156298219016600, -2.47322794795975, 6.14246263542509,	0.0, 0.0, 1.0;

    Eigen::Matrix<double, 60, 2> Rs;
    Rs <<1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0;        

    Eigen::Matrix<double, 40, 1> dd;
    dd <<1.20000000000000,
        12.0,
        1.20000000000000,
        12.0,
        1.20000000000000,
        12.0,
        1.20000000000000,
        12.0,
        1.20000000000000,
        12.0,
        1.20000000000000,
        12.0,
        1.20000000000000,
        12.0,
        1.20000000000000,
        12.0,
        1.20000000000000,
        12.0,
        1.20000000000000,
        12.0,
        2.0,
        33.3898000000000,
        2.0,
        33.3898000000000,
        2.0,
        33.3898000000000,
        2.0,
        33.3898000000000,
        2.0,
        33.3898000000000,
        2.0,
        6.61020000000000,
        2.0,
        6.61020000000000,
        2.0,
        6.61020000000000,
        2.0,
        6.61020000000000,
        2.0,
        6.61020000000000;

    Eigen::Matrix<double, 40, 2> dupast;
    dupast <<0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            -1.0, 0.0,
            0.0, -1.0,
            -1.0, 0.0,
            0.0, -1.0,
            -1.0, 0.0,
            0.0, -1.0,
            -1.0, 0.0,
            0.0, -1.0,
            -1.0, 0.0,
            0.0, -1.0,
            1.0, 0.0,
            0.0, 1.0,
            1.0, 0.0,
            0.0, 1.0,
            1.0, 0.0,
            0.0, 1.0,
            1.0, 0.0,
            0.0, 1.0,
            1.0, 0.0,
            0.0, 1.0;         
    */

    //Updated Model Spec
    Eigen::Matrix<double, 9, 9> A_MPC_SCR;
    A_MPC_SCR <<0.988303788868735, 0.956829275721058, -0.0475784038628204, -0.851406873089384, 0.0161014415422266, -0.00928284258039210, -0.0236049423011128, 0.00551189040500842, 0.0,
                -0.00504487142083283, 0.427517456151319, 0.0204940641345111, -0.217871888899683, -4.98230457154761e-05,	-0.00876842476811453, 0.0208863816156044, -0.00376676910398808, 0.0,
                0.00983162632736217, -1.63539957988862,	-0.128313290819311,	-4.20028146895285, 7.18111642734196e-05, -0.0231221031910466, 0.274023467609398, -0.0716224753004491, 0.0,
                0.000480991257420739, -0.162225954648086, 0.0383726060928523, 0.684582929379962, 2.48014255189741e-06, 0.000122514504830343, 0.0254392109383727, -0.00543246812644712, 0.0,
                0.0, 0.0, 0.0, 0.0,	0.618783391806141, 0.0,	0.0, 0.0, 0.0,
                0.00622564366654418, -0.808096580145375, -0.198110135955530, -2.68432108496922,	4.85749611072077e-05, 0.216211527948784, -0.103137113298239, -0.0455520229623938, 0.0,
                0.00785290198758295, -1.39140353669246,	-0.396821142465637,	-5.76926463890825, 5.60239585336837e-05, -0.209424555146209, 0.912216058898158,	-0.0985725645870690, 0.0,
                0.00650691592136939, -1.64304326153812,	0.0210399167107554,	2.10335738049081, 4.10551906629788e-05,	0.0136992291868433,	0.00172974372062621, 0.999015722572996,	0.0,
                0.00650691592136939, -1.64304326153812,	0.0210399167107554,	2.10335738049081, 4.10551906629788e-05,	0.0136992291868433,	0.00172974372062621, -0.000984277427004409, 1.0;
    Eigen::Matrix<double, 9, 2> B_MPC_SCR;
    B_MPC_SCR <<-0.0177671461896709, 0.00418188720359372,
                0.0121712440683987,	-8.86304176405474e-06,
                0.233322162264240, 9.92057020758965e-06,
                0.0175258775827737,	2.60333938829440e-07,
                0.0, 0.381216608193859,
                0.149099858368945, 6.97257611492242e-06,
                0.320498527706422, 7.61840137661589e-06,
                -0.116845857371769,	5.18816423479338e-06,
                0.00315414262823086, 5.18816423479338e-06;
    Eigen::Matrix<double, 2, 9> C_MPC_SCR;
    C_MPC_SCR <<0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	1.0,
                1.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0;            

    Eigen::Matrix<double, 40, 10> CC; 
    CC <<1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0,	0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 1.0, 0.0,	0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 1.0,	0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	1.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, 1.0,
        -1.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0,
        0.0, -1.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0,
        0.0, 0.0, -1.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, -1.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	-1.0, 0.0, 0.0,	0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, -1.0, 0.0,	0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, -1.0,	0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, -1.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	-1.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, -1.0,
        1.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0,
        0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        1.0, 0.0, 1.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0,
        0.0, 1.0, 0.0, 1.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0,
        1.0, 0.0, 1.0, 0.0,	1.0, 0.0, 0.0, 0.0,	0.0, 0.0,
        0.0, 1.0, 0.0, 1.0,	0.0, 1.0, 0.0, 0.0,	0.0, 0.0,
        1.0, 0.0, 1.0, 0.0,	1.0, 0.0, 1.0, 0.0,	0.0, 0.0,
        0.0, 1.0, 0.0, 1.0,	0.0, 1.0, 0.0, 1.0,	0.0, 0.0,
        1.0, 0.0, 1.0, 0.0,	1.0, 0.0, 1.0, 0.0,	1.0, 0.0,
        0.0, 1.0, 0.0, 1.0,	0.0, 1.0, 0.0, 1.0,	0.0, 1.0,
        -1.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0,
        0.0, -1.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0,
        -1.0, 0.0, -1.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,
        0.0, -1.0, 0.0,	-1.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,
        -1.0, 0.0, -1.0, 0.0, -1.0,	0.0, 0.0, 0.0, 0.0,	0.0,
        0.0, -1.0, 0.0,	-1.0, 0.0, -1.0, 0.0, 0.0, 0.0,	0.0,
        -1.0, 0.0, -1.0, 0.0, -1.0,	0.0, -1.0, 0.0,	0.0, 0.0,
        0.0, -1.0, 0.0, -1.0, 0.0, -1.0, 0.0, -1.0,	0.0, 0.0,
        -1.0, 0.0, -1.0, 0.0, -1.0,	0.0, -1.0, 0.0,	-1.0, 0.0,
        0.0, -1.0, 0.0,	-1.0, 0.0, -1.0, 0.0, -1.0,	0.0, -1.0;

    Eigen::Matrix<double, 10, 10> E;
    E <<233.623846811616, -6.67475275291013, 222.245088639912, -6.65638268071209, 210.915493540514,	-6.60538135256243, 199.511905960100, -6.52216278385728,	188.066532689884, -6.40749631129746,
        -6.67475275291013, 4.54998041111870, -6.36143984715080,	4.31163073277686, -6.04186246849384, 4.08702993879443, -5.71762730905593, 3.86171626058937,	-5.39054393087445, 3.63630781935304,
        222.245088639912, -6.36143984715080, 211.935796426652, -6.35441130778917, 201.211171706567,	-6.31590355901887, 190.540227973826, -6.24589059633905,	179.800162836538, -6.14487838460659,
        -6.65638268071209, 4.31163073277686, -6.35441130778917,	4.11874597406376, -6.04527498145573, 3.89428592824099, -5.73016749735545, 3.68366093685824,	-5.41070431300974, 3.47241151508500,
        210.915493540514, -6.04186246849384, 201.211171706567, -6.04527498145573, 191.536213075412,	-6.01889859770116, 181.450306501686, -5.96213597834343,	171.422808034929, -5.87505030695842,
        -6.60538135256243, 4.08702993879443, -6.31590355901887,	3.89428592824099, -6.01889859770116, 3.71480018896413, -5.71501865603800, 3.50382406511279,	-5.40546650493829, 3.30677023657506,
        199.511905960100, -5.71762730905593, 190.540227973826, -5.73016749735545, 181.450306501686,	-5.71501865603800, 172.393998384291, -5.67114055206045,	162.931324350136, -5.59802225358280,
        -6.52216278385728, 3.86171626058937, -6.24589059633905,	3.68366093685824, -5.96213597834343, 3.50382406511279, -5.67114055206045, 3.33732902983205,	-5.37356567112981, 3.13942956316529,
        188.066532689884, -5.39054393087445, 179.800162836538, -5.41070431300974, 171.422808034929,	-5.40546650493829, 162.931324350136, -5.37356567112981,	154.477889733878, -5.31404518340676,
        -6.40749631129746, 3.63630781935304, -6.14487838460659, 3.47241151508500, -5.87505030695842, 3.30677023657506, -5.59802225358280, 3.13942956316529,	-5.31404518340676, 2.98551531168022;                 
    
    Eigen::Matrix<double, 60, 10> H;
    H <<0.00315414262823086,5.18816423479338e-06,0,0,0,0,0,0,0,0,
        -0.0177671461896709,0.00418188720359372,0,0,0,0,0,0,0,0,
        0.0306790003901851,6.86606919662152e-05,0.00315414262823086,5.18816423479338e-06,0,0,0,0,0,0,
        -0.0592968914651803,0.0144436090697952,-0.0177671461896709,0.00418188720359372,0,0,0,0,0,0,
        0.0946957036031508,0.000293544947567428,0.0306790003901851,6.86606919662152e-05,0.00315414262823086,5.18816423479338e-06,0,0,0,0,
        -0.112011231322049,0.0283317764259239,-0.0592968914651803,0.0144436090697952,-0.0177671461896709,0.00418188720359372,0,0,0,0,
        0.190349772921294,0.000795764941184245,0.0946957036031508,0.000293544947567428,0.0306790003901851,6.86606919662152e-05,0.00315414262823086,5.18816423479338e-06,0,0,
        -0.170623490404455,0.0443019977026886,-0.112011231322049,0.0283317764259239,-0.0592968914651803,0.0144436090697952,-0.0177671461896709,0.00418188720359372,0,0,
        0.305967238082344,0.00168418025692675,0.190349772921294,0.000795764941184245,0.0946957036031508,0.000293544947567428,0.0306790003901851,6.86606919662152e-05,0.00315414262823086,5.18816423479338e-06,
        -0.232902102624938,0.0613863380529822,-0.170623490404455,0.0443019977026886,-0.112011231322049,0.0283317764259239,-0.0592968914651803,0.0144436090697952,-0.0177671461896709,0.00418188720359372,
        0.430925853913365,0.00304839437568308,0.305967238082344,0.00168418025692675,0.190349772921294,0.000795764941184245,0.0946957036031508,0.000293544947567428,0.0306790003901851,6.86606919662152e-05,
        -0.297227412056897,0.0789824840754984,-0.232902102624938,0.0613863380529822,-0.170623490404455,0.0443019977026886,-0.112011231322049,0.0283317764259239,-0.0592968914651803,0.0144436090697952,
        0.558351517961308,0.00495197856658689,0.430925853913365,0.00304839437568308,0.305967238082344,0.00168418025692675,0.190349772921294,0.000795764941184245,0.0946957036031508,0.000293544947567428,
        -0.362078829592129,0.0967197006724318,-0.297227412056897,0.0789824840754984,-0.232902102624938,0.0613863380529822,-0.170623490404455,0.0443019977026886,-0.112011231322049,0.0283317764259239,
        0.684668963631172,0.00743128187018139,0.558351517961308,0.00495197856658689,0.430925853913365,0.00304839437568308,0.305967238082344,0.00168418025692675,0.190349772921294,0.000795764941184245,
        -0.426223373957693,0.114373814818009,-0.362078829592129,0.0967197006724318,-0.297227412056897,0.0789824840754984,-0.232902102624938,0.0613863380529822,-0.170623490404455,0.0443019977026886,
        0.808319039853504,0.0104985676703537,0.684668963631172,0.00743128187018139,0.558351517961308,0.00495197856658689,0.430925853913365,0.00304839437568308,0.305967238082344,0.00168418025692675,
        -0.488873506587470,0.131813357601568,-0.426223373957693,0.114373814818009,-0.362078829592129,0.0967197006724318,-0.297227412056897,0.0789824840754984,-0.232902102624938,0.0613863380529822,
        0.928755807844449,0.0141473316053637,0.808319039853504,0.0104985676703537,0.684668963631172,0.00743128187018139,0.558351517961308,0.00495197856658689,0.430925853913365,0.00304839437568308,
        -0.549657909381828,0.148965349337862,-0.488873506587470,0.131813357601568,-0.426223373957693,0.114373814818009,-0.362078829592129,0.0967197006724318,-0.297227412056897,0.0789824840754984,
        1.04590537802859,0.0183579440490898,0.928755807844449,0.0141473316053637,0.808319039853504,0.0104985676703537,0.684668963631172,0.00743128187018139,0.558351517961308,0.00495197856658689,
        -0.608491971736842,0.165793448622356,-0.549657909381828,0.148965349337862,-0.488873506587470,0.131813357601568,-0.426223373957693,0.114373814818009,-0.362078829592129,0.0967197006724318,
        1.15992261734790,0.0231025474442787,1.04590537802859,0.0183579440490898,0.928755807844449,0.0141473316053637,0.808319039853504,0.0104985676703537,0.684668963631172,0.00743128187018139,
        -0.665446846709969,0.182283941557550,-0.608491971736842,0.165793448622356,-0.549657909381828,0.148965349337862,-0.488873506587470,0.131813357601568,-0.426223373957693,0.114373814818009,
        1.27107746700115,0.0283488327829066,1.15992261734790,0.0231025474442787,1.04590537802859,0.0183579440490898,0.928755807844449,0.0141473316053637,0.808319039853504,0.0104985676703537,
        -0.720659484752055,0.198436763038742,-0.665446846709969,0.182283941557550,-0.608491971736842,0.165793448622356,-0.549657909381828,0.148965349337862,-0.488873506587470,0.131813357601568,
        1.37968677753159,0.0340627235302914,1.27107746700115,0.0283488327829066,1.15992261734790,0.0231025474442787,1.04590537802859,0.0183579440490898,0.928755807844449,0.0141473316053637,
        -0.774283616214403,0.214259779978585,-0.720659484752055,0.198436763038742,-0.665446846709969,0.182283941557550,-0.608491971736842,0.165793448622356,-0.549657909381828,0.148965349337862,
        1.48606730285116,0.0402101573812047,1.37968677753159,0.0340627235302914,1.27107746700115,0.0283488327829066,1.15992261734790,0.0231025474442787,1.04590537802859,0.0183579440490898,
        -0.826467241324902,0.229765195742027,-0.774283616214403,0.214259779978585,-0.720659484752055,0.198436763038742,-0.665446846709969,0.182283941557550,-0.608491971736842,0.165793448622356,
        1.59050674446230,0.0467581849338512,1.48606730285116,0.0402101573812047,1.37968677753159,0.0340627235302914,1.27107746700115,0.0283488327829066,1.15992261734790,0.0231025474442787,
        -0.877343774316950,0.244967328186042,-0.826467241324902,0.229765195742027,-0.774283616214403,0.214259779978585,-0.720659484752055,0.198436763038742,-0.665446846709969,0.182283941557550,
        1.69325102545015,0.0536755800134343,1.59050674446230,0.0467581849338512,1.48606730285116,0.0402101573812047,1.37968677753159,0.0340627235302914,1.27107746700115,0.0283488327829066,
        -0.927029470724786,0.259881268522935,-0.877343774316950,0.244967328186042,-0.826467241324902,0.229765195742027,-0.774283616214403,0.214259779978585,-0.720659484752055,0.198436763038742,
        1.79450321370940,0.0609331185513411,1.69325102545015,0.0536755800134343,1.59050674446230,0.0467581849338512,1.48606730285116,0.0402101573812047,1.37968677753159,0.0340627235302914,
        -0.975623773799816,0.274522097505885,-0.927029470724786,0.259881268522935,-0.877343774316950,0.244967328186042,-0.826467241324902,0.229765195742027,-0.774283616214403,0.214259779978585,
        1.89442872808122,0.0685036457930236,1.79450321370940,0.0609331185513411,1.69325102545015,0.0536755800134343,1.59050674446230,0.0467581849338512,1.48606730285116,0.0402101573812047,
        -1.02321109887090,0.288904448587579,-0.975623773799816,0.274522097505885,-0.927029470724786,0.259881268522935,-0.877343774316950,0.244967328186042,-0.826467241324902,0.229765195742027,
        1.99316269110888,0.0763620189739961,1.89442872808122,0.0685036457930236,1.79450321370940,0.0609331185513411,1.69325102545015,0.0536755800134343,1.59050674446230,0.0467581849338512,
        -1.06986324694923,0.303042282875524,-1.02321109887090,0.288904448587579,-0.975623773799816,0.274522097505885,-0.927029470724786,0.259881268522935,-0.877343774316950,0.244967328186042,
        2.09081707180099,0.0844849854414484,1.99316269110888,0.0763620189739961,1.89442872808122,0.0685036457930236,1.79450321370940,0.0609331185513411,1.69325102545015,0.0536755800134343,
        -1.11564190446347,0.316948790135040,-1.06986324694923,0.303042282875524,-1.02321109887090,0.288904448587579,-0.975623773799816,0.274522097505885,-0.927029470724786,0.259881268522935,
        2.18748664352975,0.0928510348203598,2.09081707180099,0.0844849854414484,1.99316269110888,0.0763620189739961,1.89442872808122,0.0685036457930236,1.79450321370940,0.0609331185513411,
        -1.16060088431640,0.330636362266445,-1.11564190446347,0.316948790135040,-1.06986324694923,0.303042282875524,-1.02321109887090,0.288904448587579,-0.975623773799816,0.274522097505885,
        2.28325356014833,0.101440248059334,2.18748664352975,0.0928510348203598,2.09081707180099,0.0844849854414484,1.99316269110888,0.0763620189739961,1.89442872808122,0.0685036457930236,
        -1.20478794645659,0.344116606430022,-1.16060088431640,0.330636362266445,-1.11564190446347,0.316948790135040,-1.06986324694923,0.303042282875524,-1.02321109887090,0.288904448587579,
        2.37819068824513,0.110234155367011,2.28325356014833,0.101440248059334,2.18748664352975,0.0928510348203598,2.09081707180099,0.0844849854414484,1.99316269110888,0.0763620189739961,
        -1.24824617477735,0.357400378218428,-1.20478794645659,0.344116606430022,-1.16060088431640,0.330636362266445,-1.11564190446347,0.316948790135040,-1.06986324694923,0.303042282875524,
        2.47236393464500,0.119215608161669,2.37819068824513,0.110234155367011,2.28325356014833,0.101440248059334,2.18748664352975,0.0928510348203598,2.09081707180099,0.0844849854414484,
        -1.29101496592735,0.370497823572698,-1.24824617477735,0.357400378218428,-1.20478794645659,0.344116606430022,-1.16060088431640,0.330636362266445,-1.11564190446347,0.316948790135040,
        2.56583381246990,0.128368666136677,2.47236393464500,0.119215608161669,2.37819068824513,0.110234155367011,2.28325356014833,0.101440248059334,2.18748664352975,0.0928510348203598,
        -1.33313071453450,0.383418423224550,-1.29101496592735,0.370497823572698,-1.24824617477735,0.357400378218428,-1.20478794645659,0.344116606430022,-1.16060088431640,0.330636362266445,
        2.65865645974094,0.137678498455071,2.56583381246990,0.128368666136677,2.47236393464500,0.119215608161669,2.37819068824513,0.110234155367011,2.28325356014833,0.101440248059334,
        -1.37462727831376,0.396171036471715,-1.33313071453450,0.383418423224550,-1.29101496592735,0.370497823572698,-1.24824617477735,0.357400378218428,-1.20478794645659,0.344116606430022,
        2.75088428511070,0.147131297202353,2.65865645974094,0.137678498455071,2.56583381246990,0.128368666136677,2.47236393464500,0.119215608161669,2.37819068824513,0.110234155367011,
        -1.41553629253776,0.408763942819803,-1.37462727831376,0.396171036471715,-1.33313071453450,0.383418423224550,-1.29101496592735,0.370497823572698,-1.24824617477735,0.357400378218428,
        2.84256637450782,0.156714201035590,2.75088428511070,0.147131297202353,2.65865645974094,0.137678498455071,2.56583381246990,0.128368666136677,2.47236393464500,0.119215608161669,
        -1.45588738648895,0.421204880958889,-1.41553629253776,0.408763942819803,-1.37462727831376,0.396171036471715,-1.33313071453450,0.383418423224550,-1.29101496592735,0.370497823572698,
        2.93374875480133,0.166415227131519,2.84256637450782,0.156714201035590,2.75088428511070,0.147131297202353,2.65865645974094,0.137678498455071,2.56583381246990,0.128368666136677,
        -1.49570833927717,0.433501085011604,-1.45588738648895,0.421204880958889,-1.41553629253776,0.408763942819803,-1.37462727831376,0.396171036471715,-1.33313071453450,0.383418423224550;

    Eigen::Matrix<double, 60, 11> P; 
    P <<0.00650691592136939,-1.64304326153812,0.0210399167107554,2.10335738049081,4.10551906629788e-05,0.0136992291868433,0.00172974372062621,-0.000984277427004409,1,1,0,
        0.988303788868735,0.956829275721058,-0.0475784038628204,-0.851406873089384,0.0161014415422266,-0.00928284258039210,-0.0236049423011128,0.00551189040500842,0,0,1,
        0.0290446020221750,-4.36977788230629,0.0826881499013423,5.86187388555322,0.000301596261290290,0.0441023582126371,0.0284251450106134,-0.0104549191975390,2,1,0,
        1.95913650138184,2.55874764577012,-0.0902348240281464,-2.11164287214267,0.0419231143510738,-0.0228392879092807,-0.0822116807600288,0.0236441985123573,0,0,1,
        0.0743328307898818,-7.91368356361804,0.166271941775914,10.5986529160008,0.00101894568023283,0.0813896709205600,0.106377925925271,-0.0393550900509424,3,1,0,
        2.90908048766470,4.50942852672505,-0.120157266632031,-3.55815021822246,0.0734437441174224,-0.0354747378877763,-0.167450593208566,0.0573716166049378,0,0,1,
        0.147233179282549,-12.0247079559926,0.244637367659740,15.7166028946912,0.00243240080803159,0.115731468361629,0.243637201460477,-0.0967137915942383,4,1,0,
        3.83655427547155,6.60930583740627,-0.140006080298887,-5.05988487852818,0.108136724204855,-0.0453014342446647,-0.270523539039569,0.107933073199187,0,0,1,
        0.250677979259551,-16.4384475284195,0.301813294450900,20.8233580658888,0.00475202685774111,0.141510092617557,0.431021272860906,-0.187623378351284,5,1,0,
        4.74112745553979,8.73883751710030,-0.152265287334345,-6.52435605815762,0.144423880830245,-0.0518946678196030,-0.385123491943037,0.175834681540192,0,0,1,
        0.385745424741259,-20.9236063043305,0.334721385912635,25.7146322874838,0.00813873370470821,0.157339645979115,0.651820302654736,-0.313714611092515,6,1,0,
        5.62305325815846,10.8256129907701,-0.158072718290085,-7.88786365955375,0.181328137770393,-0.0553555661425877,-0.506354437943480,0.261064384100653,0,0,1,
        0.552055255556831,-25.3150452677380,0.347477603772407,30.3088873556081,0.0126961281753246,0.164405631016078,0.889696496143577,-0.474441423124012,7,1,0,
        6.48300444616404,12.8237339708891,-0.158257132053716,-9.11446015082545,0.218252926737121,-0.0560648156749755,-0.629949429767144,0.363141724316375,0,0,1,
        0.748282436097093,-29.5151548262456,0.346087255294347,34.5895833819071,0.0184732280297002,0.164843744682889,1.13213666494347,-0.668177807119376,8,1,0,
        7.32191461858671,14.7049055835885,-0.153933344605467,-10.1912341281791,0.254842450900663,-0.0545851333652254,-0.752264809966889,0.481224126016553,0,0,1,
        0.972601698740585,-33.4775974410903,0.335785167001548,38.5699142919056,0.0254740261390233,0.160774129258013,1.37080344261680,-0.892878423243901,9,1,0,
        8.14086407614133,16.4544224969159,-0.146439290250047,-11.1205772889990,0.290893085290825,-0.0515460053442213,-0.870510241046146,0.614257741838062,0,0,1,
        1.22299420626061,-37.1884841257422,0.320373869573898,42.2750944866377,0.0336694236156307,0.153920465477005,1.60065723939496,-1.14640589632050,10,1,0,
        8.94099150216508,18.0679653576420,-0.137052571086425,-11.9128482150092,0.326296937693344,-0.0475327786827527,-0.982837341737110,0.761113550415242,0,0,1,
        1.49742924233101,-40.6520104632902,0.302416992239167,45.7340499259946,0.0430084411096823,0.145552249860982,1.81894794453512,-1.42667947410322,11,1,0,
        9.72343003354997,19.5483031168397,-0.126790705493019,-12.5812676198080,0.361005707175833,-0.0430189998358420,-1.08823227219202,0.920678429707870,0,0,1,
        1.79395997263096,-43.8814164151345,0.283589766264487,48.9752928754214,0.0534272938797238,0.136548314438082,2.02443818237363,-1.73174333716873,12,1,0,
        10.4892669923313,20.9023134785812,-0.116359530086294,-13.1390996048961,0.395007495342322,-0.0383475175139273,-1.18630733932064,1.09190250151891,0,0,1,
        2.11076779238379,-46.8937921741634,0.264950675365015,52.0247415333297,0.0648560704811637,0.127483526948208,2.21686574406843,-2.05979738748996,13,1,0,
        11.2395230450177,22.1387458820362,-0.106196248088029,-13.5984087041741,0.428311982826498,-0.0337437392233119,-1.27708819874926,1.27381701962382,0,0,1,
        2.44617769137503,-49.7071771880379,0.247122766432405,54.9047208436672,0.0772233076294966,0.118707190227336,2.39657062567689,-2.40920589877635,14,1,0,
        11.9751447707090,23.2667991915926,-0.0965425043702344,-13.9696775136318,0.460941044645736,-0.0293418613318108,-1.36084474656966,1.46553651047953,0,0,1,
        2.79865760914851,-52.3389698615154,0.230423050753612,57.6337948621590,0.0904589170134387,0.110408087612373,2.56423119852311,-2.77849136622557,15,1,0,
        12.6970051356005,24.2953463813521,-0.0875109959703223,-14.2618225001667,0.492922898326435,-0.0252116495047079,-1.43797397563661,1.66625391037510,0,0,1,
        3.16680933963139,-54.8051282961610,0.214964026334795,60.2271229797783,0.104495904250535,0.102666932178824,2.72068126689807,-3.16631967012392,16,1,0,
        13.4059079323616,25.2325816645354,-0.0791347255801022,-14.4823706997034,0.524288529369711,-0.0213804961994775,-1.50892522130029,1.87523315985749,0,0,1,
        3.54935566588670,-57.1198733279345,0.200733650099226,62.6970568306300,0.119271247359710,0.0954969951377296,2.86679159125048,-3.57148187734146,17,1,0,
        14.1025937800731,26.0859090759391,-0.0714003550802342,-14.6376883466509,0.555069567287784,-0.0178497764749320,-1.57415517388010,2.09180128270517,0,0,1,
        3.94512666153484,-59.2956993844192,0.187654027477732,65.0537720153195,0.134726221707331,0.0888736909599340,3.00340125820036,-3.99287639287278,18,1,0,
        14.7877463781028,26.8619558517553,-0.0642700462199850,-14.7332104305799,0.585297071927873,-0.0146062498570187,-1.63410259167284,2.31534086684271,0,0,1,
        4.35304684941774,-61.3435484379579,0.175620300120673,67.3058221540050,0.150806385158787,0.0827545340665702,3.13128430416721,-4.42949338149332,19,1,0,
        15.4619983728571,27.5666434754393,-0.0576954239870000,-14.7736454458863,0.615000880915768,-0.0116296227715795,-1.68917576356918,2.54528337484551,0,0,1,
        4.77212400036219,-63.2730454221785,0.164523581105105,69.4605754288044,0.167461374699191,0.0770914701516530,3.25113865826439,-4.88040203447063,20,1,0,
        16.1259365695766,28.2052793736838,-0.0516260824623047,-14.7631434856063,0.644209295338063,-0.00889728054919750,-1.73974799340881,2.78110344678153,0,0,1,
        5.20143975885918,-65.0927334224244,0.154262684248912,71.5245353991986,0.184644615190737,0.0718377238058139,3.36358754352257,-5.34474050975741,21,1,0,
        16.7801064250324,28.7826491860089,-0.0460142866625657,-14.7054253368117,0.672948963357913,-0.00638701060299485,-1.78615781735093,3.02231418479831,0,0,1,
        5.64014195361334,-66.8102784320007,0.144748854653189,73.5035652772227,0.202313002396523,0.0669510407805565,3.46918675066628,-5.82170808079575,22,1,0,
        17.4250158645209,29.3030993930473,-0.0408171191999439,-14.6038763903616,0.701244874944250,-0.00407836814938766,-1.82871168083086,3.26846330309349,0,0,1,
        6.08743831377453,-68.4326340067940,0.135906573773280,75.4030385965560,0.220426595014565,0.0623947581176460,3.56843385910801,-6.31055898603036,23,1,0,
        18.0611385165162,29.7706061931649,-0.0359970447843710,-14.4616121534208,0.729120415191216,-0.00195318543713138,-1.86768758784530,3.51912998146858,0,0,1,
        6.54259128880730,-69.9661672299477,0.127672420529261,77.2279370658858,0.238948332392006,0.0581376906148681,3.66177731155555,-6.81059753274506,24,1,0,
        18.6889164726512,30.1888302533262,-0.0315216112181676,-14.2815226849011,0.756597445400861,4.41035755013863e-06,-1.90333884185488,3.77392225960813,0,0,1,
        7.00491370270743,-71.4167521115793,0.119993161774500,78.9829124452001,0.257843783584531,0.0541534638267516,3.74962438075375,-7.32117409914161,25,1,0,
        19.3087626743312,30.5611589773436,-0.0273627689235530,-14.0663024001234,0.783696394561454,0.00180822294539615,-1.93589743102718,4.03247483244644,0,0,1,
        7.47376502564904,-72.7898377067655,0.112823719177868,80.6723252122690,0.277080927352980,0.0504196672314880,3.83234771520930,-7.84168176678659,26,1,0,
        19.9210630110247,30.8907387321855,-0.0234960970273636,-13.8184702867266,0.810436351980455,0.00347030233302879,-1.96557688865960,4.29444713822597,0,0,1,
        7.94854809953844,-74.0904977087723,0.106125336345394,82.3002691803852,0.296629959804637,0.0469170300775257,3.91029049526322,-8.37155339142981,27,1,0,
        20.5261781963811,31.1804995134011,-0.0199000854235978,-13.5403841681204,0.836835156566181,0.00500126344532149,-1.99257461698558,4.55952166059822,0,0,1,
        8.42870620029793,-75.3234671012138,0.0998640769401933,83.8705882693724,0.316463125410948,0.0436287141581700,3.98377039208459,-8.91025898111325,28,1,0,
        21.1244454708549,31.4331741905269,-0.0165555346985989,-13.2342514747024,0.862909480884861,0.00641056637707366,-2.01707373802011,4.82740239044285,0,0,1,
        8.91372035646314,-76.4931701478337,0.0940096738215477,85.3868893544277,0.336554567197592,0.0405397531420464,4.05308257550911,-9.45730329656508,29,1,0,
        21.7161801652460,31.6513140060653,-0.0134450864691452,-12.9021380904056,0.888674909492740,0.00770674377552920,-2.03924456129581,5.09781341130445,0,0,1,
        9.40310687095649,-77.6037428012671,0.0885346916996161,86.8525534765412,0.356880192453677,0.0376366328092105,4.11850201000492,-10.0122236216282,30,1,0,
        22.3016771488090,31.8373015473181,-0.0105528722454108,-12.5459762075464,0.914146011692251,0.00889757564553814,-2.05924575819431,5.37049758519964,0,0,1;

    Eigen::Matrix<double, 60, 2> Rs;
    Rs <<1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0;

    Eigen::Matrix<double, 40, 1> dd;
    dd <<1.20000000000000,
        12,
        1.20000000000000,
        12,
        1.20000000000000,
        12,
        1.20000000000000,
        12,
        1.20000000000000,
        12,
        1.20000000000000,
        12,
        1.20000000000000,
        12,
        1.20000000000000,
        12,
        1.20000000000000,
        12,
        1.20000000000000,
        12,
        2,
        33.6645000000000,
        2,
        33.6645000000000,
        2,
        33.6645000000000,
        2,
        33.6645000000000,
        2,
        33.6645000000000,
        2,
        6.33550000000000,
        2,
        6.33550000000000,
        2,
        6.33550000000000,
        2,
        6.33550000000000,
        2,
        6.33550000000000;
        
    Eigen::Matrix<double, 40, 2> dupast;
    dupast <<0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            -1.0, 0.0,
            0.0, -1.0,
            -1.0, 0.0,
            0.0, -1.0,
            -1.0, 0.0,
            0.0, -1.0,
            -1.0, 0.0,
            0.0, -1.0,
            -1.0, 0.0,
            0.0, -1.0,
            1.0, 0.0,
            0.0, 1.0,
            1.0, 0.0,
            0.0, 1.0,
            1.0, 0.0,
            0.0, 1.0,
            1.0, 0.0,
            0.0, 1.0,
            1.0, 0.0,
            0.0, 1.0;             

    Eigen::Matrix<double, 9, 1> x_prev;
    Eigen::Matrix<double, 60, 1> ref;
    Eigen::Matrix<double, 9, 1> x;
    Eigen::Matrix<double, 2, 1> y;
    Eigen::Matrix<double, 2, 1> u;
    Eigen::Matrix<double, 11, 1> Xf;
    Eigen::Matrix<double, 10, 1> F;
    Eigen::Matrix<double, 40, 1> d;
    Eigen::Matrix<double, 10, 1> DeltaU;
    x <<0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0;
    u <<0.0,
        0.0;
    bool MPC_Activate=false;     

    int MPC_P=30;//choose
	float MPC_Ts=0.12;//choose
    float gamma=(float)(4*M_PI/180);//From PX4       

    //publish a few values before starting to allow changing into offboard mode
    for(int i = 100; ros::ok() && i > 0; --i){
        //!!!MAKE A WAY TO WAIT FOR CALLBACK to be first called before passing!!!
        // if(mpc_ins.state>=1){
        //     // Run MPC
        //     MPC_Activate=true;
        //     //Set inputs to MPC

        //     // for(int i=0;i<60;i++){
        //     //     MPC_ref[i]=mpc_ins.mpc_ref_in[i];
        //     //     ref(i)=(double)MPC_ref[i];
        //     // }

        //     MPC_ref[0]=mpc_ins.mpc_ref_in[0];
        //     MPC_ref[1]=mpc_ins.mpc_ref_in[1];
            
        //     // MPC referance generator
        //     for(int i=0;i<MPC_P;i++){
		//         if(mpc_ins.state>=2){
		// 	        ref(i*2)=MPC_ref[0]+(i)*tan(-gamma)*MPC_Ts*mpc_ins.grd_vel;
		// 	        ref(i*2+1)=MPC_ref[1];
		//         }else{
		// 	        ref(i*2)=MPC_ref[0];
		// 	        ref(i*2+1)=MPC_ref[1];
		//         }
	    //     }


        //     MPC_mo[0]=mpc_ins.mpc_mo_in[0];MPC_mo[1]=mpc_ins.mpc_mo_in[1];

        //     Eigen::Matrix<double, 9, 1> x_prev;
        //     x_prev <<(double)MPC_mo[1],
        //             x(1),
        //             x(2),
        //             x(3),
        //             x(4),
        //             x(5),
        //             x(6),
        //             x(7),
        //             (double)MPC_mo[0];

        //     // TESTING
        //     // std::cout<<"MPC_in ref: "<<mpc_ins.mpc_ref_in[0]<<" ; "<<mpc_ins.mpc_ref_in[37]<<"\n";
        //     // std::cout<<"MPC_in mo: "<<mpc_ins.mpc_mo_in[0]<<" ; "<<mpc_ins.mpc_mo_in[1]<<"\n";

        //     // Model predictions
        //     x = A_MPC_SCR*x_prev + B_MPC_SCR*u;
        //     y = C_MPC_SCR*x;

        //     Eigen::Matrix<double, 9, 1> deltax=x-x_prev;
        //     Eigen::Matrix<double, 11, 1> Xf;
        //     Xf <<deltax(0),
        //         deltax(1),
        //         deltax(2),
        //         deltax(3),
        //         deltax(4),
        //         deltax(5),
        //         deltax(6),
        //         deltax(7),
        //         deltax(8),
        //         y(0),
        //         y(1);

        //     F=-2*H.transpose()*(ref-P*Xf);

        //     d = dd + dupast*u;

        //     DeltaU=QPhild(E, F, CC, d);

        //     Eigen::Matrix<double, 5, 2> DeltaU_1;
        //     DeltaU_1 <<DeltaU(0,0), DeltaU(1,0),
        //                DeltaU(2,0), DeltaU(3,0),
        //                DeltaU(4,0), DeltaU(5,0),
        //                DeltaU(6,0), DeltaU(7,0),
        //                DeltaU(8,0), DeltaU(9,0);

        //     Eigen::Matrix<double, 1, 2> deltau= DeltaU_1.row(0);

        //     u = u + deltau.transpose();            

        //     mpc_outs.mpc_mv_out[0]=(float)u(0);
        //     mpc_outs.mpc_mv_out[1]=(float)u(1);
        //     //!!!ADD publish to topic!!!
        //     mpc_outputs_pub.publish(mpc_outs);

        // }

        // TESTING
        // std::cout<< "MPC_mv : " << MPC_mv[0] <<" ; " << MPC_mv[1]<<"\n";

        // Required for now to allow vehicle to go into offbaord mode(CHECK if you can make mpc outputs publish do the same)
        local_pos_pub.publish(pose);

        //Run callback functions
        ros::spinOnce();
        //Loop back after 0.02 seconds is over
        rate.sleep();
    }

    mavros_msgs::SetMode offb_set_mode;
    offb_set_mode.request.custom_mode = "OFFBOARD";

    // mavros_msgs::CommandBool arm_cmd;
    // arm_cmd.request.value = true;

    ros::Time last_request = ros::Time::now();

    while(ros::ok()){
        // if( current_state.mode != "OFFBOARD" &&
        //     (ros::Time::now() - last_request > ros::Duration(5.0))){
        //     if( set_mode_client.call(offb_set_mode) &&
        //         offb_set_mode.response.mode_sent){
        //         ROS_INFO("Offboard enabled");
        //     }
        //     last_request = ros::Time::now();
        // } else {
        //     if( !current_state.armed &&
        //         (ros::Time::now() - last_request > ros::Duration(5.0))){
        //         if( arming_client.call(arm_cmd) &&
        //             arm_cmd.response.success){
        //             ROS_INFO("Vehicle armed");
        //         }
        //         last_request = ros::Time::now();
        //     }
        // }

        if( current_state.mode != "OFFBOARD" &&
            (ros::Time::now() - last_request > ros::Duration(5.0))){
            if( set_mode_client.call(offb_set_mode) &&
                offb_set_mode.response.mode_sent){
                ROS_INFO("Offboard enabled");
            }
            last_request = ros::Time::now();
        }

        // Required for now to allow vehicle to go into offbaord mode(CHECK if you can make mpc outputs publish do the same)
        local_pos_pub.publish(pose);

        if(current_state.mode == "OFFBOARD"){
        //MPC reset condition
        if(MPC_Activate && mpc_ins.state==0){
            std::cout<<"Reset MPC\n";
            MPC_Activate=false;
            // x(0)=0.0;x(1)=0.0;x(2)=0.0;x(3)=0.0;x(4)=0.0;x(5)=0.0;x(6)=0.0;x(7)=0.0;x(8)=0.0;
            // u(0)=0.0;u(1)=0.0;
            x.setZero(9,1);
            u.setZero(2,1);
            // std::cout<<"x : "<<x<<"\n";
        }

        if(mpc_ins.state>=1){
            // Run MPC 
            MPC_Activate=true;       
            //Set inputs to MPC

            // for(int i=0;i<60;i++){
            //     MPC_ref[i]=mpc_ins.mpc_ref_in[i];
            //     ref(i)=(double)MPC_ref[i];
            // }

            MPC_ref[0]=mpc_ins.mpc_ref_in[0];
            MPC_ref[1]=mpc_ins.mpc_ref_in[1];
            
            // MPC referance generator
            for(int i=0;i<MPC_P;i++){
		        if(mpc_ins.state>=2){
			        ref(i*2)=MPC_ref[0]+(i)*tan(-gamma)*MPC_Ts*mpc_ins.grd_vel;
			        ref(i*2+1)=MPC_ref[1];
		        }else{
			        ref(i*2)=MPC_ref[0];
			        ref(i*2+1)=MPC_ref[1];
		        }
	        }

            MPC_mo[0]=mpc_ins.mpc_mo_in[0];MPC_mo[1]=mpc_ins.mpc_mo_in[1];
            
            // std::cout<<"MPC_in ref: "<<ref(0)<<" ; "<<ref(1)<<"\n";
            // std::cout<<"MPC_in mo: "<<MPC_mo[0]<<" ; "<<MPC_mo[1]<<"\n";

            Eigen::Matrix<double, 9, 1> x_prev;
            x_prev <<(double)MPC_mo[1],
                    x(1),
                    x(2),
                    x(3),
                    x(4),
                    x(5),
                    x(6),
                    x(7),
                    (double)MPC_mo[0];

            // TESTING
            // std::cout<<"MPC_in ref: "<<mpc_ins.mpc_ref_in[0]<<" ; "<<mpc_ins.mpc_ref_in[37]<<"\n";
            // std::cout<<"MPC_in mo: "<<mpc_ins.mpc_mo_in[0]<<" ; "<<mpc_ins.mpc_mo_in[1]<<"\n";

            // Model predictions
            x = A_MPC_SCR*x_prev + B_MPC_SCR*u;
            y = C_MPC_SCR*x;

            Eigen::Matrix<double, 9, 1> deltax=x-x_prev;
            Eigen::Matrix<double, 11, 1> Xf;
            Xf <<deltax(0),
                deltax(1),
                deltax(2),
                deltax(3),
                deltax(4),
                deltax(5),
                deltax(6),
                deltax(7),
                deltax(8),
                y(0),
                y(1);

            F=-2*H.transpose()*(ref-P*Xf);

            d = dd + dupast*u;

            DeltaU=QPhild(E, F, CC, d);

            Eigen::Matrix<double, 5, 2> DeltaU_1;
            DeltaU_1 <<DeltaU(0,0), DeltaU(1,0),
                       DeltaU(2,0), DeltaU(3,0),
                       DeltaU(4,0), DeltaU(5,0),
                       DeltaU(6,0), DeltaU(7,0),
                       DeltaU(8,0), DeltaU(9,0);

            Eigen::Matrix<double, 1, 2> deltau= DeltaU_1.row(0);

            u = u + deltau.transpose();            

            mpc_outs.mpc_mv_out[0]=(float)u(0);
            mpc_outs.mpc_mv_out[1]=(float)u(1);
            //!!!ADD publish to topic!!!
            mpc_outputs_pub.publish(mpc_outs);
        }
        //!!!TESTING!!!
        // std::cout<< "MPC_mv : " << MPC_mv[0] <<" ; " << MPC_mv[1]<<"\n";
        // std_msgs::String msg_out;
        // std::stringstream ss;
        // ss << "MPC_mv : " << MPC_mv[0] <<" ; " << MPC_mv[1];
        // msg_out.data = ss.str();
        // ROS_INFO("%s", msg_out.data.c_str());
        }

        ros::spinOnce();
        rate.sleep();
    }
    //Teminate MPC
    // MPC0_terminate();

    return 0;
}

