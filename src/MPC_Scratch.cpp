#include <ros/ros.h>
#include <mavros_msgs/CommandBool.h>
#include <mavros_msgs/SetMode.h>
#include <mavros_msgs/State.h>
#include <cmath>
#include <algorithm>
#include "std_msgs/String.h"
#include <mavros_msgs/MPC_Inputs.h>
#include <mavros_msgs/MPC_Outputs.h>
#include <geometry_msgs/PoseStamped.h>
#include <iostream>

#include <sstream>
#include <Eigen/Dense>
#include <unsupported/Eigen/MatrixFunctions>
#include <Eigen/Core>
#include <Eigen/Cholesky>

mavros_msgs::State current_state;
void state_cb(const mavros_msgs::State::ConstPtr& msg){
    current_state = *msg;
}

//Callback function for MPC inputs topic
mavros_msgs::MPC_Inputs mpc_ins;
void mpc_inputs_cb(const mavros_msgs::MPC_Inputs::ConstPtr& msg){
    mpc_ins = *msg;
}


Eigen::Matrix<double, 10, 1> QPhild(const Eigen::Matrix<double, 10, 10> &E, Eigen::Matrix<double, 10, 1> &F, const Eigen::Matrix<double, 40, 10> &CC, Eigen::Matrix<double, 40, 1> &d)
{
    // Compute decomposition of E
    // static Eigen::LLT<Eigen::Matrix<double, 8, 8>> lltOfE(E);
    static Eigen::Matrix<double, 10, 40> CC_transd = CC.transpose();
    // Eigen::Matrix<double, 8, 1> DeltU=-lltOfE.solve(F);
    Eigen::Matrix<double, 10, 1> DeltU=-E.colPivHouseholderQr().solve(F);

    int kk=0;
    for(int i=0;i<40;i++){
        if(CC.row(i)*DeltU>d(i)){
            kk++;
        }else{
            kk+=0;
        }
    }

    if(kk==0){
        return DeltU;
    }else{

    // std::cout<<"Limiting MPC output\n";

    // Eigen::Matrix<double, 32, 32> T = CC*(lltOfE.solve(CC_transd));
    // Eigen::Matrix<double, 32, 1> K = (CC*(lltOfE.solve(F)) + d);

    Eigen::Matrix<double, 40, 40> T = CC*(E.colPivHouseholderQr().solve(CC_transd));
    Eigen::Matrix<double, 40, 1> K = (CC*(E.colPivHouseholderQr().solve(F)) + d);

    int k_row = 40;
    Eigen::Matrix<double, 40, 1> lambda;
    lambda.setZero(40, 1);
    double al = 3.0;
    int km = 0;

    do
    {
        Eigen::Matrix<double, 40, 1> lambda_p = lambda;
        // loop to determine lambda values for respective iterations
        int i = 0;
        do
        {
            // float Tii = T(i, i);
            // // T(i, i) = 0;
            // float la = -(T.col(i).dot(lambda) + K(i)) / Tii;
            // T(i, i) = Tii;

            double w= T.row(i)*lambda-T(i,i)*lambda(i);
            w = w + K(i);
            double la = -w/T(i,i);
            if (la < 0.0f) lambda(i) = 0.0f;
            else lambda(i) = la;
            i++;
        } while (i < k_row);
        // al = (lambda - lambda_p).squaredNorm();
        al = (lambda - lambda_p).transpose()*(lambda - lambda_p);

        if (al < 0.001f) break;
        km++;
    } while (km < 15);

    // DeltU = -lltOfE.solve(F) - (lltOfE.solve(CC_transd))*lambda;
    DeltU = -E.colPivHouseholderQr().solve(F) - (E.colPivHouseholderQr().solve(CC_transd))*lambda;

    return DeltU;
    }
}

//MPC inputs and outputs declaration !!!ADD Assign in callback function of own topic and find way to convert double array to float array!!!
float MPC_ref[2]={0,0};
float MPC_mo[2]={0,0};
float MPC_mv[2]={0,0};


int main(int argc, char **argv)
{
    ros::init(argc, argv, "MPC_handler");
    ros::NodeHandle nh;

    ros::Subscriber state_sub = nh.subscribe<mavros_msgs::State>
            ("mavros/state", 10, state_cb);

    //!!!Make New Subscriber(PX4->ROS) and Publisher(ROS->PX4) to your own topics!!!
    ros::Subscriber mpc_in_sub = nh.subscribe<mavros_msgs::MPC_Inputs>
            ("/mavros/mpc_inputs_topic", 1, mpc_inputs_cb);

    ros::Publisher mpc_outputs_pub = nh.advertise<mavros_msgs::MPC_Outputs>
            ("/mavros/mpc_outputs/mpc_outputs_topic", 1);        

    // Required for now to allow vehicle to go into offbaord mode(CHECK if you can make mpc outputs publish do the same)
    ros::Publisher local_pos_pub = nh.advertise<geometry_msgs::PoseStamped>
            ("mavros/setpoint_position/local", 10);

    ros::ServiceClient arming_client = nh.serviceClient<mavros_msgs::CommandBool>
            ("mavros/cmd/arming");
    ros::ServiceClient set_mode_client = nh.serviceClient<mavros_msgs::SetMode>
            ("mavros/set_mode");

    //the setpoint publishing rate MUST be faster than 2Hz
    ros::Rate rate(10.0);//10Hz corresponds to 0.1 seconds

     // wait for FCU connection
    while(ros::ok() && !current_state.connected){
        ros::spinOnce();
        rate.sleep();
    }

    // Required for now to allow vehicle to go into offbaord mode(CHECK if you can make mpc outputs publish do the same)
    geometry_msgs::PoseStamped pose;
    pose.pose.position.x = 0;
    pose.pose.position.y = 0;
    pose.pose.position.z = 2;

    //!!!Define Struct for publish topic!!!
    mavros_msgs::MPC_Outputs mpc_outs;

    //Intialise MPC Matrices                     

    /*
    //Aero Coeff tune (MPC Ts=0.08)
    Eigen::Matrix<double, 9, 9> A_MPC_SCR;
    A_MPC_SCR <<0.994117296583461,0.802927731928133,-0.0504299106818950,-0.633605552139330,0.0116011629669788,-0.000787174317024567,-0.0156756950743316,0.00277792390596143,0,
                -0.00404422965157559,0.666006011685161,0.0281018760989965,-0.110707003500327,-2.63798434133523e-05,-0.00674667684162920,0.0129952322347532,-0.00205423063033697,0,
                0.00497518786148901,-1.56215969606169,0.129246358699955,-2.77964679050302,2.34079955865293e-05,-0.0251107328177309,0.269266480556146,-0.0516605572030864,0,
                0.000149790784941794,-0.0818690479505680,0.0403959297978421,0.872028613230864,5.11246003189018e-07,-0.00111611572299814,0.0137099321823849,-0.00239239029046999,0,
                0,0,0,0,0.726149037073691,0,0,0,0,
                0.00274014304434448,-0.806575977610195,-0.141588877717710,-2.24160352182853,1.31717209086130e-05,0.435830901764444,-0.0408888607723158,-0.0416186353803174,0,
                0.00334752964385771,-1.12641363184991,-0.245726231859597,-3.53491547277187,1.52838798977577e-05,-0.114688474986807,0.988074210479829,-0.0657560200259900,0,
                0.00316849277677302,-1.24298115132095,0.00901039339679783,1.43792861813732,1.35904704706377e-05,0.00498481688394449,-0.000362334066069950,0.999941841164624,0,
                0.00316849277677302,-1.24298115132095,0.00901039339679783,1.43792861813732,1.35904704706377e-05,0.00498481688394449,-0.000362334066069951,-5.81588353758243e-05,1;

    Eigen::Matrix<double, 9, 2> B_MPC_SCR;
    B_MPC_SCR <<-0.00825817977941648,0.00195715285454235,
                0.00611368638483995,-2.98545923103626e-06,
                0.154504030944002,2.04498401275607e-06,
                0.00711260976386360,3.46453179943276e-08,
                0,0.273850962926309,
                0.124576140827257,1.16441416594760e-06,
                0.196439188348341,1.30936811810626e-06,
                -0.0798296968153690,1.12126252533256e-06,
                0.000170303184630980,1.12126252533256e-06;

    Eigen::Matrix<double, 2, 9> C_MPC_SCR;
    C_MPC_SCR <<0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	1.0,
                1.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0;

    Eigen::Matrix<double, 40, 10> CC; 
    CC <<1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0,	0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 1.0, 0.0,	0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 1.0,	0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	1.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, 1.0,
        -1.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0,
        0.0, -1.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0,
        0.0, 0.0, -1.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, -1.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	-1.0, 0.0, 0.0,	0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, -1.0, 0.0,	0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, -1.0,	0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, -1.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	-1.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, -1.0,
        1.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0,
        0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        1.0, 0.0, 1.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0,
        0.0, 1.0, 0.0, 1.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0,
        1.0, 0.0, 1.0, 0.0,	1.0, 0.0, 0.0, 0.0,	0.0, 0.0,
        0.0, 1.0, 0.0, 1.0,	0.0, 1.0, 0.0, 0.0,	0.0, 0.0,
        1.0, 0.0, 1.0, 0.0,	1.0, 0.0, 1.0, 0.0,	0.0, 0.0,
        0.0, 1.0, 0.0, 1.0,	0.0, 1.0, 0.0, 1.0,	0.0, 0.0,
        1.0, 0.0, 1.0, 0.0,	1.0, 0.0, 1.0, 0.0,	1.0, 0.0,
        0.0, 1.0, 0.0, 1.0,	0.0, 1.0, 0.0, 1.0,	0.0, 1.0,
        -1.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0,
        0.0, -1.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0,
        -1.0, 0.0, -1.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,
        0.0, -1.0, 0.0,	-1.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,
        -1.0, 0.0, -1.0, 0.0, -1.0,	0.0, 0.0, 0.0, 0.0,	0.0,
        0.0, -1.0, 0.0,	-1.0, 0.0, -1.0, 0.0, 0.0, 0.0,	0.0,
        -1.0, 0.0, -1.0, 0.0, -1.0,	0.0, -1.0, 0.0,	0.0, 0.0,
        0.0, -1.0, 0.0, -1.0, 0.0, -1.0, 0.0, -1.0,	0.0, 0.0,
        -1.0, 0.0, -1.0, 0.0, -1.0,	0.0, -1.0, 0.0,	-1.0, 0.0,
        0.0, -1.0, 0.0,	-1.0, 0.0, -1.0, 0.0, -1.0,	0.0, -1.0;            

    Eigen::Matrix<double, 10, 10> E;
    E <<93.2172750931091,-3.83826718311297,88.1681479549898,-3.77796096313441,83.2284586708218,-3.70200401130226,78.2604891653444,-3.61072108407428,73.2787013616333,-3.50459983301727,
        -3.83826718311297,1.96062914804818,-3.64060145651998,1.84638210902454,-3.44143216444384,1.74674389063012,-3.24152481000945,1.64694692022200,-3.04172338618247,1.54725736914064,
        88.1681479549898,-3.64060145651998,83.7688258331613,-3.58804771753063,79.0229385113656,-3.52048905117051,74.3905747250231,-3.43811095312905,69.7343432960223,-3.34129369606787,
        -3.77796096313441,1.84638210902454,-3.58804771753063,1.76908212905176,-3.39615632934568,1.66124453272153,-3.20293393985713,1.56805716690276,-3.00915436564203,1.47475397160263,
        83.2284586708218,-3.44143216444384,79.0229385113656,-3.39615632934568,74.9170964572697,-3.33666345079118,70.4686445436126,-3.26297050181687,66.1379879072894,-3.17531671308925,
        -3.70200401130226,1.74674389063012,-3.52048905117051,1.66124453272153,-3.33666345079118,1.59011276045681,-3.15103311033422,1.48848472742554,-2.96425374771667,1.40154983424492,
        78.2604891653444,-3.24152481000945,74.3905747250231,-3.20293393985713,70.4686445436126,-3.15103311033422,66.6502156777459,-3.08569328486460,62.4933059270656,-3.00698336621407,
        -3.61072108407428,1.64694692022200,-3.43811095312905,1.56805716690276,-3.26297050181687,1.48848472742554,-3.08569328486460,1.42332109971751,-2.90679401354373,1.32770402732583,
        73.2787013616333,-3.04172338618247,69.7343432960223,-3.00915436564203,66.1379879072894,-2.96425374771667,62.4933059270656,-2.90679401354373,58.9561093870899,-2.83669622508686,
        -3.50459983301727,1.54725736914064,-3.34129369606787,1.47475397160263,-3.17531671308925,1.40154983424492,-3.00698336621407,1.32770402732583,-2.83669622508686,1.26830966972427;

    Eigen::Matrix<double, 60, 10> H;
    H << 0.000170303184630980,1.12126252533256e-06,0,0,0,0,0,0,0,0,
        -0.00825817977941648,0.00195715285454235,0,0,0,0,0,0,0,0,
        0.00488926611661474,1.59498910666152e-05,0.000170303184630980,1.12126252533256e-06,0,0,0,0,0,0,
        -0.0272562890897740,0.00707724149396637,-0.00825817977941648,0.00195715285454235,0,0,0,0,0,0,
        0.0192116873423020,7.23170398900526e-05,0.00488926611661474,1.59498910666152e-05,0.000170303184630980,1.12126252533256e-06,0,0,0,0,
        -0.0520535861490272,0.0144586973634770,-0.0272562890897740,0.00707724149396637,-0.00825817977941648,0.00195715285454235,0,0,0,0,
        0.0459517927032407,0.000206077187254660,0.0192116873423020,7.23170398900526e-05,0.00488926611661474,1.59498910666152e-05,0.000170303184630980,1.12126252533256e-06,0,0,
        -0.0804877479444261,0.0234363399449217,-0.0520535861490272,0.0144586973634770,-0.0272562890897740,0.00707724149396637,-0.00825817977941648,0.00195715285454235,0,0,
        0.0857991670607256,0.000456306387091448,0.0459517927032407,0.000206077187254660,0.0192116873423020,7.23170398900526e-05,0.00488926611661474,1.59498910666152e-05,0.000170303184630980,1.12126252533256e-06,
        -0.111753495568434,0.0335194923024786,-0.0804877479444261,0.0234363399449217,-0.0520535861490272,0.0144586973634770,-0.0272562890897740,0.00707724149396637,-0.00825817977941648,0.00195715285454235,
        0.137882312992468,0.000862432542329752,0.0857991670607256,0.000456306387091448,0.0459517927032407,0.000206077187254660,0.0192116873423020,7.23170398900526e-05,0.00488926611661474,1.59498910666152e-05,
        -0.145562298181963,0.0443465731524125,-0.111753495568434,0.0335194923024786,-0.0804877479444261,0.0234363399449217,-0.0520535861490272,0.0144586973634770,-0.0272562890897740,0.00707724149396637,
        0.200404498072690,0.00146227905872934,0.137882312992468,0.000862432542329752,0.0857991670607256,0.000456306387091448,0.0459517927032407,0.000206077187254660,0.0192116873423020,7.23170398900526e-05,
        -0.181716593024577,0.0556515620035428,-0.145562298181963,0.0443465731524125,-0.111753495568434,0.0335194923024786,-0.0804877479444261,0.0234363399449217,-0.0520535861490272,0.0144586973634770,
        0.271177289198660,0.00229058714053501,0.200404498072690,0.00146227905872934,0.137882312992468,0.000862432542329752,0.0857991670607256,0.000456306387091448,0.0459517927032407,0.000206077187254660,
        -0.219942956866304,0.0672391838985862,-0.181716593024577,0.0556515620035428,-0.145562298181963,0.0443465731524125,-0.111753495568434,0.0335194923024786,-0.0804877479444261,0.0234363399449217,
        0.347996916226176,0.00337788544589556,0.271177289198660,0.00229058714053501,0.200404498072690,0.00146227905872934,0.137882312992468,0.000862432542329752,0.0857991670607256,0.000456306387091448,
        -0.259865514647052,0.0789665591079404,-0.219942956866304,0.0672391838985862,-0.181716593024577,0.0556515620035428,-0.145562298181963,0.0443465731524125,-0.111753495568434,0.0335194923024786,
        0.428870581257645,0.00474969525746121,0.347996916226176,0.00337788544589556,0.271177289198660,0.00229058714053501,0.200404498072690,0.00146227905872934,0.137882312992468,0.000862432542329752,
        -0.301040832757305,0.0907296561222684,-0.259865514647052,0.0789665591079404,-0.219942956866304,0.0672391838985862,-0.181716593024577,0.0556515620035428,-0.145562298181963,0.0443465731524125,
        0.512125149044569,0.00642607941335377,0.428870581257645,0.00474969525746121,0.347996916226176,0.00337788544589556,0.271177289198660,0.00229058714053501,0.200404498072690,0.00146227905872934,
        -0.343008541008013,0.102453303624386,-0.301040832757305,0.0907296561222684,-0.259865514647052,0.0789665591079404,-0.219942956866304,0.0672391838985862,-0.181716593024577,0.0556515620035428,
        0.596435416580957,0.00842152230904545,0.512125149044569,0.00642607941335377,0.428870581257645,0.00474969525746121,0.347996916226176,0.00337788544589556,0.271177289198660,0.00229058714053501,
        -0.385335224140593,0.114083826143141,-0.343008541008013,0.102453303624386,-0.301040832757305,0.0907296561222684,-0.259865514647052,0.0789665591079404,-0.219942956866304,0.0672391838985862,
        0.680804192097711,0.0107450998081287,0.596435416580957,0.00842152230904545,0.512125149044569,0.00642607941335377,0.428870581257645,0.00474969525746121,0.347996916226176,0.00337788544589556,
        -0.427643582861041,0.125583603632002,-0.385335224140593,0.114083826143141,-0.343008541008013,0.102453303624386,-0.301040832757305,0.0907296561222684,-0.259865514647052,0.0789665591079404,
        0.764518198048374,0.0134008772669955,0.680804192097711,0.0107450998081287,0.596435416580957,0.00842152230904545,0.512125149044569,0.00642607941335377,0.428870581257645,0.00474969525746121,
        -0.469626655317979,0.136927036286943,-0.427643582861041,0.125583603632002,-0.385335224140593,0.114083826143141,-0.343008541008013,0.102453303624386,-0.301040832757305,0.0907296561222684,
        0.847095734694521,0.0163884653522350,0.764518198048374,0.0134008772669955,0.680804192097711,0.0107450998081287,0.596435416580957,0.00842152230904545,0.512125149044569,0.00642607941335377,
        -0.511050278054464,0.148097534313048,-0.469626655317979,0.136927036286943,-0.427643582861041,0.125583603632002,-0.385335224140593,0.114083826143141,-0.343008541008013,0.102453303624386,
        0.928235520633323,0.0197036655054596,0.847095734694521,0.0163884653522350,0.764518198048374,0.0134008772669955,0.680804192097711,0.0107450998081287,0.596435416580957,0.00842152230904545,
        -0.551747793655211,0.159085256655750,-0.511050278054464,0.148097534313048,-0.469626655317979,0.136927036286943,-0.427643582861041,0.125583603632002,-0.385335224140593,0.114083826143141,
        1.00777147905216,0.0233391462713481,0.928235520633323,0.0197036655054596,0.847095734694521,0.0163884653522350,0.764518198048374,0.0134008772669955,0.680804192097711,0.0107450998081287,
        -0.591610573568001,0.169885399957988,-0.551747793655211,0.159085256655750,-0.511050278054464,0.148097534313048,-0.469626655317979,0.136927036286943,-0.427643582861041,0.125583603632002,
        1.08563525028025,0.0272851046099510,1.00777147905216,0.0233391462713481,0.928235520633323,0.0197036655054596,0.847095734694521,0.0163884653522350,0.764518198048374,0.0134008772669955,
        -0.630577021104591,0.180496895188734,-0.591610573568001,0.169885399957988,-0.551747793655211,0.159085256655750,-0.511050278054464,0.148097534313048,-0.469626655317979,0.136927036286943,
        1.16182648539043,0.0315298798914171,1.08563525028025,0.0272851046099510,1.00777147905216,0.0233391462713481,0.928235520633323,0.0197036655054596,0.847095734694521,0.0163884653522350,
        -0.668621786708224,0.190921409596257,-0.630577021104591,0.180496895188734,-0.591610573568001,0.169885399957988,-0.551747793655211,0.159085256655750,-0.511050278054464,0.148097534313048,
        1.23639011195591,0.0360605006494037,1.16182648539043,0.0315298798914171,1.08563525028025,0.0272851046099510,1.00777147905216,0.0233391462713481,0.928235520633323,0.0197036655054596,
        -0.705746158994151,0.201162580050436,-0.668621786708224,0.190921409596257,-0.630577021104591,0.180496895188734,-0.591610573568001,0.169885399957988,-0.551747793655211,0.159085256655750,
        1.30939943447859,0.0408631543758124,1.23639011195591,0.0360605006494037,1.16182648539043,0.0315298798914171,1.08563525028025,0.0272851046099510,1.00777147905216,0.0233391462713481,
        -0.741970043825980,0.211225423760061,-0.705746158994151,0.201162580050436,-0.668621786708224,0.190921409596257,-0.630577021104591,0.180496895188734,-0.591610573568001,0.169885399957988,
        1.38094390267992,0.0459235783687392,1.30939943447859,0.0408631543758124,1.23639011195591,0.0360605006494037,1.16182648539043,0.0315298798914171,1.08563525028025,0.0272851046099510,
        -0.777325592234582,0.221115886302126,-0.741970043825980,0.211225423760061,-0.705746158994151,0.201162580050436,-0.668621786708224,0.190921409596257,-0.630577021104591,0.180496895188734,
        1.45112049667669,0.0512273750174883,1.38094390267992,0.0459235783687392,1.30939943447859,0.0408631543758124,1.23639011195591,0.0360605006494037,1.16182648539043,0.0315298798914171,
        -0.811852341727251,0.230840496729984,-0.777325592234582,0.221115886302126,-0.741970043825980,0.211225423760061,-0.705746158994151,0.201162580050436,-0.668621786708224,0.190921409596257,
        1.52002784728803,0.0567602582684230,1.45112049667669,0.0512273750174883,1.38094390267992,0.0459235783687392,1.30939943447859,0.0408631543758124,1.23639011195591,0.0360605006494037,
        -0.845593646552065,0.240406106548838,-0.811852341727251,0.230840496729984,-0.777325592234582,0.221115886302126,-0.741970043825980,0.211225423760061,-0.705746158994151,0.201162580050436,
        1.58776238322251,0.0625082397916254,1.52002784728803,0.0567602582684230,1.45112049667669,0.0512273750174883,1.38094390267992,0.0459235783687392,1.30939943447859,0.0408631543758124,
        -0.878594150266387,0.249819694465488,-0.845593646552065,0.240406106548838,-0.811852341727251,0.230840496729984,-0.777325592234582,0.221115886302126,-0.741970043825980,0.211225423760061,
        1.65441595213389,0.0684577639833732,1.58776238322251,0.0625082397916254,1.52002784728803,0.0567602582684230,1.45112049667669,0.0512273750174883,1.38094390267992,0.0459235783687392,
        -0.910898068600586,0.259088222642220,-0.878594150266387,0.249819694465488,-0.845593646552065,0.240406106548838,-0.811852341727251,0.230840496729984,-0.777325592234582,0.221115886302126,
        1.72007449201802,0.0745958007629078,1.65441595213389,0.0684577639833732,1.58776238322251,0.0625082397916254,1.52002784728803,0.0567602582684230,1.45112049667669,0.0512273750174883,
        -0.942548082188362,0.268218533112761,-0.910898068600586,0.259088222642220,-0.878594150266387,0.249819694465488,-0.845593646552065,0.240406106548838,-0.811852341727251,0.230840496729984,
        1.78481743322402,0.0809099044518661,1.72007449201802,0.0745958007629078,1.65441595213389,0.0684577639833732,1.58776238322251,0.0625082397916254,1.52002784728803,0.0567602582684230,
        -0.973584675219137,0.277217275311691,-0.942548082188362,0.268218533112761,-0.910898068600586,0.259088222642220,-0.878594150266387,0.249819694465488,-0.845593646552065,0.240406106548838,
        1.84871759270566,0.0873882460863314,1.78481743322402,0.0809099044518661,1.72007449201802,0.0745958007629078,1.65441595213389,0.0684577639833732,1.58776238322251,0.0625082397916254,
        -1.00404579097088,0.286090857497108,-0.973584675219137,0.277217275311691,-0.942548082188362,0.268218533112761,-0.910898068600586,0.259088222642220,-0.878594150266387,0.249819694465488,
        1.91184138509045,0.0940196254652210,1.84871759270566,0.0873882460863314,1.78481743322402,0.0809099044518661,1.72007449201802,0.0745958007629078,1.65441595213389,0.0684577639833732,
        -1.03396670557101,0.294845416321143,-1.00404579097088,0.286090857497108,-0.973584675219137,0.277217275311691,-0.942548082188362,0.268218533112761,-0.910898068600586,0.259088222642220;   

    Eigen::Matrix<double, 60, 11> P; 
    P <<0.00316849277677302,-1.24298115132095,0.00901039339679783,1.43792861813732,1.35904704706377e-05,0.00498481688394449,-0.000362334066069951,-5.81588353758243e-05,1,1,0,
        0.994117296583461,0.802927731928133,-0.0504299106818950,-0.633605552139330,0.0116011629669788,-0.000787174317024567,-0.0156756950743316,0.00277792390596143,0,0,1,
        0.0147862190232486,-3.44658887669594,0.0415646380501487,4.23034877700215,0.000107602878035793,0.0187357823075173,0.00465112021568694,-0.00170150537601606,2,1,0,
        1.97874763526351,2.28137835729021,-0.106123934448045,-1.70354709948715,0.0315353553504808,-0.00354470861144221,-0.0585482859635548,0.0118524712103036,0,0,1,
        0.0390454877697811,-6.44202130759481,0.101879837376052,8.19854275982282,0.000384795388283680,0.0400542766935764,0.0269119329686768,-0.00810821404006589,3,1,0,
        2.95104681554373,4.27045736194174,-0.153643929961144,-3.09851828205308,0.0573919867374325,-0.00794130822116417,-0.126687438486096,0.0289954381751500,0,0,1,
        0.0794518690498886,-10.1139007130420,0.185037718125978,13.1097495715804,0.000964098245720601,0.0659919530615806,0.0790134771630388,-0.0233124241336119,4,1,0,
        3.90895075331321,6.62331137379456,-0.191752431713049,-4.74377145964557,0.0873923924897411,-0.0133920831721091,-0.215153841478775,0.0552081191571822,0,0,1,
        0.138985657497630,-14.3626239839088,0.281352141565355,18.7159634671716,0.00196936226554662,0.0934015203930759,0.170449900686194,-0.0514697626304073,5,1,0,
        4.85104007851524,9.22514516130585,-0.222580275235939,-6.57733010541429,0.120225089170917,-0.0193257147788540,-0.319609411913096,0.0911958016528543,0,0,1,
        0.220131449215081,-19.0870170420155,0.380276741488048,24.7824437654997,0.00352216261748986,0.119647400775562,0.305971673996738,-0.0963315371042605,6,1,0,
        5.77638503336579,11.9903955578627,-0.248194164753739,-8.54121926132202,0.154924371503153,-0.0252272796139330,-0.436985027631065,0.137548380650037,0,0,1,
        0.324859215300626,-24.1805716838946,0.472855806396477,31.1047514127112,0.00573655627088771,0.142859684245597,0.485599510589242,-0.160946030222325,7,1,0,
        6.68441932255757,14.8552069649815,-0.269698615899089,-10.5802319705545,0.190780507369770,-0.0306562219454600,-0.565128436602057,0.194773725206929,0,0,1,
        0.454606702085504,-29.5347697286697,0.552799274771606,37.5161991936491,0.00871502997536940,0.161938770508165,0.705570339611433,-0.247546451233777,8,1,0,
        7.57485102424874,17.7703912254328,-0.287358817312001,-12.6435932548029,0.227273288263862,-0.0352674641354087,-0.702292718602833,0.263274400295284,0,0,1,
        0.610285377213641,-35.0448088824058,0.616598007377417,43.8885463596470,0.0125454864181456,0.176436589914320,0.959620446519040,-0.357567869544076,9,1,0,
        8.44760321730510,20.6964652397685,-0.300999995117448,-14.6870281954810,0.264022932689087,-0.0388268808651789,-0.846775962858762,0.343316174402937,0,0,1,
        0.792314091229026,-40.6149768608859,0.663106902423560,50.1286201858147,0.0172992966239998,0.186392546055875,1.24022423426156,-0.491739416194747,10,1,0,
        9.30277379414504,23.6007372535728,-0.310365662952331,-16.6741525838425,0.300753871294981,-0.0412136621999247,-0.996764044016440,0.435009087615793,0,0,1,
        1.00067510029797,-46.1624241573090,0.692919820714105,56.1729585462122,0.0230304220229398,0.192169953228676,1.53959601581519,-0.650210355887357,11,1,0,
        10.1406057629006,26.4558558735482,-0.315338425309706,-18.5769194672639,0.337268053151076,-0.0424092320812926,-1.15032793450924,0.538305988897064,0,0,1,
        1.23498361083479,-51.6190564740544,0.707739387743890,61.9819018567729,0.0297755204670068,0.194316313459395,1.85039492529112,-0.832682203787489,12,1,0,
        10.9614624616949,29.2391911993605,-0.316028074550276,-20.3752517884718,0.373425250641121,-0.0424768785681553,-1.30550546895255,0.653015808820269,0,0,1,
        1.49456210635898,-56.9317882031205,0.709845571087256,67.5339896774451,0.0375548693005836,0.193456048846427,2.16615081042174,-1.03853060028023,13,1,0,
        11.7658048624614,31.9325694717214,-0.312766951536836,-22.0561304859065,0.409128483988069,-0.0415374354926038,-1.46040931002239,0.778826234985355,0,0,1,
        1.77851252457776,-62.0616043782560,0.701699206733571,72.8210922346591,0.0463738927475697,0.190215548610267,2.48146510049143,-1.26690913301437,14,1,0,
        12.5541700181621,34.5220700337679,-0.306055530143953,-23.6124086864046,0.444313180537937,-0.0397455144732845,-1.61332397054472,0.915330534179966,0,0,1,
        2.08578165247723,-66.9818967999406,0.685677129161126,77.8444261210459,0.0562250725167962,0.185175951518155,2.79204993627651,-1.51683283885998,15,1,0,
        13.3271507316079,36.9977474910696,-0.296491384057990,-25.0415645145355,0.478939059177717,-0.0372691881825952,-1.76277405115788,1.06205447274373,0,0,1,
        2.41521723006228,-71.6764656176705,0.663916766335561,82.6114379313170,0.0670900405569143,0.178847483924267,3.09466344650749,-1.78724232989896,16,1,0,
        14.0853769202921,39.3532442878791,-0.284702273370376,-26.3445329312114,0.512984010568209,-0.0342744606241543,-1.90755957080003,1.21848073773673,0,0,1,
        2.76561391185878,-76.1374721121108,0.638242455652188,87.1334559956954,0.0789416894293351,0.171659232596666,3.38698738867266,-2.07705105719871,17,1,0,
        14.8294991672279,41.5853144679958,-0.271293552026421,-27.5246931665955,0.546439449471544,-0.0309146806210673,-2.04676222928529,1.38406952616289,0,0,1,
        3.13574937289815,-80.3635261512850,0.610147362009263,91.4239791698646,0.0917461783825917,0.163959108088612,3.66748053272491,-2.38517875359273,18,1,0,
        15.5601747811842,43.6933011566902,-0.256812795059928,-28.5870407633046,0.579306763654293,-0.0273243318077948,-2.17972992287311,1.55827489739606,0,0,1,
        3.52441152438430,-84.3580083435271,0.580809671434193,95.4974705332436,0.105464754486148,0.156019909489708,3.93522976545286,-2.71057403258958,19,1,0,
        16.2780564727780,45.6786115494829,-0.241730298321634,-29.5375423623701,0.611594589120334,-0.0236162965866272,-2.30604740014358,1.74055707448507,0,0,1,
        3.93041813011486,-88.1276663509032,0.551127257772593,99.3685376964651,0.120055343776398,0.148048530016256,4.18981193023097,-3.05222876929915,20,1,0,
        16.9837835588167,47.5442243228999,-0.226432164030647,-30.3826541384186,0.643316715441076,-0.0198816265932379,-2.42549993267788,1.93039119735842,0,0,1,
        4.35263019752801,-91.6814852465991,0.521760024572597,103.051400888659,0.135473895416670,0.140196301498550,4.43117297362478,-3.40918643765761,21,1,0,
        17.6779754670377,49.2942522910237,-0.211222233662722,-31.1289773241543,0.674490476752879,-0.0161909464243789,-2.53803523093484,2.12727315525866,0,0,1,
        4.78996044979147,-95.0298088613944,0.493173117341180,106.559569904833,0.151675482204676,0.132569220325766,4.65952669213189,-3.78054612906232,22,1,0,
        18.3612272318801,50.9335717186315,-0.196329491939588,-31.7830230036195,0.705135520339571,-0.0125967843726888,-2.64372713831528,2.33072312909347,0,0,1,
        5.24137803751414,-98.1836780489552,0.465677119618051,109.905668859560,0.168615174191170,0.125237337590735,4.87527276186027,-4.16546357927505,23,1,0,
        19.0341066406632,52.4675207163472,-0.181918271617766,-32.3510605533598,0.735272870483471,-0.00913630659563652,-2.74274317971830,2.54028741200074,0,0,1,
        5.70591046834417,-101.154348593770,0.439463330775152,113.101362624823,0.186248709970391,0.118242965560589,5.07893230856424,-4.56315019958925,24,1,0,
        19.6971526951537,53.9016630007576,-0.168099352443523,-32.8390278814548,0.764924223853686,-0.00583409731281561,-2.83531693060489,2.75553898595775,0,0,1,
        6.18264354989500,-103.952952921295,0.414633483230927,116.157350780251,0.204532993729735,0.111607590728231,5.27109863540167,-4.97287084438727,25,1,0,
        20.3508750825205,55.2416097135366,-0.154940721680794,-33.2524857858405,0.794111426416963,-0.00270476301307052,-2.92172540594805,2.97607723681693,0,0,1,
        6.67071997290377,-106.590273618310,0.391223997150621,119.083404206289,0.223426446656591,0.105337527064293,5.45240057078369,-5.39394084241085,26,1,0,
        20.9957543909602,56.4928903854497,-0.142477291638468,-33.5966026822274,0.822856092238715,0.000244759712819974,-3.00227119116500,3.20152710218622,0,0,1,
        7.16933701514480,-109.076601583668,0.369225262153680,121.888426558541,0.242889239841654,0.0994284214916650,5.62347601913260,-5.82572266311927,27,1,0,
        21.6322428506393,57.6608638934046,-0.130719247536119,-33.8761593442316,0.851179332592683,0.00301324208680619,-3.07726877893682,3.43153787155381,0,0,1,
        7.67774372468640,-111.421656538261,0.348596606124148,124.580528219828,0.262883433205381,0.0938687595574228,5.78495355571967,-6.26762247249988,28,1,0,
        22.2607654247061,58.7506608646054,-0.119658947960599,-34.0955660698801,0.879101570167751,0.00560355008797227,-3.14703446984589,3.66578179727428,0,0,1,
        8.19523784269890,-113.634552160704,0.329277650404416,127.167104319941,0.283373041804757,0.0886425288484727,5.93744021803054,-6.71908674606493,29,1,0,
        22.8817211148991,59.7671500299072,-0.109276449555910,-34.2588868673337,0.906642418274713,0.00802135638567235,-3.21187918598405,3.90395262757121,0,0,1,
        8.72116264870747,-115.723792070536,0.311196717418728,129.654911354130,0.304324047563373,0.0837311918513702,6.08151396112256,-7.17959904353875,30,1,0,
        23.4954843803198,60.7149222412911,-0.0995438061769011,-34.3698669165551,0.933820609097790,0.0102741391495269,-3.27210359397568,4.14576413669914,0,0,1;

    Eigen::Matrix<double, 60, 2> Rs;
    Rs <<1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0,
        1.0, 0.0,
        0.0, 1.0;   

    Eigen::Matrix<double, 40, 1> dd;
    dd <<1.20000000000000,
        12,
        1.20000000000000,
        12,
        1.20000000000000,
        12,
        1.20000000000000,
        12,
        1.20000000000000,
        12,
        1.20000000000000,
        12,
        1.20000000000000,
        12,
        1.20000000000000,
        12,
        1.20000000000000,
        12,
        1.20000000000000,
        12,
        2,
        33.6706000000000,
        2,
        33.6706000000000,
        2,
        33.6706000000000,
        2,
        33.6706000000000,
        2,
        33.6706000000000,
        2,
        6.32940000000000,
        2,
        6.32940000000000,
        2,
        6.32940000000000,
        2,
        6.32940000000000,
        2,
        6.32940000000000;   
        
    Eigen::Matrix<double, 40, 2> dupast;
    dupast <<0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            -1.0, 0.0,
            0.0, -1.0,
            -1.0, 0.0,
            0.0, -1.0,
            -1.0, 0.0,
            0.0, -1.0,
            -1.0, 0.0,
            0.0, -1.0,
            -1.0, 0.0,
            0.0, -1.0,
            1.0, 0.0,
            0.0, 1.0,
            1.0, 0.0,
            0.0, 1.0,
            1.0, 0.0,
            0.0, 1.0,
            1.0, 0.0,
            0.0, 1.0,
            1.0, 0.0,
            0.0, 1.0; 
    */

    //Aero Coeff tune CD0 (MPC Ts=0.1)
      Eigen::Matrix<double, 9, 9> A_MPC_SCR;
    A_MPC_SCR <<0.954757272451600,0.973298799436851,-0.0525931731131598,-0.737919241741298,0.0136720164092165,-0.00153066722182538,-0.0217594706699177,0.00404396477760214,0,
                -0.00477791466503284,0.581480946610702,0.0268275041278013,-0.151103541587169,-3.89844233955685e-05,-0.00887120001148471,0.0171906553404253,-0.00275736257275365,0,
                0.00670559482919177,-1.51826216068533,0.00892019902893249,-3.17151969581671,4.01848161920364e-05,-0.0334520147785992,0.280637898745330,-0.0575949158847920,0,
                0.000263047634038604,-0.109562671901199,0.0417375443583329,0.809729899073168,1.12829187546604e-06,-0.00194469493045293,0.0192400029407072,-0.00348275568559488,0,
                0,0,0,0,0.670320046035639,0,0,0,0,
                0.00350957929634186,-0.708709562839557,-0.161996544987097,-2.42352992940300,2.17622608798235e-05,0.346200284509591,-0.0615142534102233,-0.0439354527743410,0,
                0.00448886108955188,-1.09567405241515,-0.300108186007220,-4.20874080083542,2.60572019468247e-05,-0.149041335452968,0.965128203936083,-0.0765498188414678,0,
                0.00485601327754128,-1.49152800790321,0.0140448421927548,1.78589630143397,2.57805160951824e-05,0.00821246332472763,0.000157075143915874,0.999718405757436,0,
                0.00485601327754127,-1.49152800790321,0.0140448421927548,1.78589630143397,2.57805160951824e-05,0.00821246332472763,0.000157075143915874,-0.000281594242563920,1;         

    Eigen::Matrix<double, 9, 2> B_MPC_SCR;
    B_MPC_SCR <<-0.0122772726989275,0.00294180021408325,
                0.00838320799413221,-5.63173442162317e-06,
                0.176267503339971,4.51316750186418e-06,
                0.0105750314572428,9.72691550840162e-08,
                0,0.329679953964361,
                0.134675538414675,2.49000257840829e-06,
                0.233870227752356,2.86482517624284e-06,
                -0.0991521673297285,2.68589219612251e-06,
                0.000847832670271520,2.68589219612251e-06;

    Eigen::Matrix<double, 2, 9> C_MPC_SCR;
    C_MPC_SCR <<0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	1.0,
                1.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0;

    Eigen::Matrix<double, 40, 10> CC; 
    CC <<1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0,	0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 1.0, 0.0,	0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 1.0,	0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	1.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, 1.0,
        -1.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0,
        0.0, -1.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0,
        0.0, 0.0, -1.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, -1.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	-1.0, 0.0, 0.0,	0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, -1.0, 0.0,	0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, -1.0,	0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, -1.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	-1.0, 0.0,
        0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, -1.0,
        1.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0,
        0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        1.0, 0.0, 1.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0,
        0.0, 1.0, 0.0, 1.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0,
        1.0, 0.0, 1.0, 0.0,	1.0, 0.0, 0.0, 0.0,	0.0, 0.0,
        0.0, 1.0, 0.0, 1.0,	0.0, 1.0, 0.0, 0.0,	0.0, 0.0,
        1.0, 0.0, 1.0, 0.0,	1.0, 0.0, 1.0, 0.0,	0.0, 0.0,
        0.0, 1.0, 0.0, 1.0,	0.0, 1.0, 0.0, 1.0,	0.0, 0.0,
        1.0, 0.0, 1.0, 0.0,	1.0, 0.0, 1.0, 0.0,	1.0, 0.0,
        0.0, 1.0, 0.0, 1.0,	0.0, 1.0, 0.0, 1.0,	0.0, 1.0,
        -1.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0,
        0.0, -1.0, 0.0,	0.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0,
        -1.0, 0.0, -1.0, 0.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,
        0.0, -1.0, 0.0,	-1.0, 0.0, 0.0,	0.0, 0.0, 0.0, 0.0,
        -1.0, 0.0, -1.0, 0.0, -1.0,	0.0, 0.0, 0.0, 0.0,	0.0,
        0.0, -1.0, 0.0,	-1.0, 0.0, -1.0, 0.0, 0.0, 0.0,	0.0,
        -1.0, 0.0, -1.0, 0.0, -1.0,	0.0, -1.0, 0.0,	0.0, 0.0,
        0.0, -1.0, 0.0, -1.0, 0.0, -1.0, 0.0, -1.0,	0.0, 0.0,
        -1.0, 0.0, -1.0, 0.0, -1.0,	0.0, -1.0, 0.0,	-1.0, 0.0,
        0.0, -1.0, 0.0,	-1.0, 0.0, -1.0, 0.0, -1.0,	0.0, -1.0; 

    Eigen::Matrix<double, 10, 10> E;
    E <<81.8646071788201,-1.23895286882878,76.6170752628124,-1.29694882987009,71.4773907374862,-1.33840573963707,66.3125476571606,-1.36316201940725,61.1432737258708,-1.37128466681177,
        -1.23895286882878,1.03128365896969,-1.19641292741398,0.963277558282704,-1.14788659717032,0.908638796059456,-1.09415544904128,0.852630138927331,-1.03610539438811,0.795564333436141,
        76.6170752628124,-1.19641292741398,72.1059431710283,-1.25346225645292,67.2426919099643,-1.29485748262506,62.4903172822827,-1.32024981065877,57.7164088255924,-1.32958006303327,
        -1.29694882987009,0.963277558282704,-1.25346225645292,0.929908525371170,-1.20371318833581,0.864808998195077,-1.14829796253225,0.813170573395528,-1.08802173556063,0.760261613328775,
        71.4773907374862,-1.14788659717032,67.2426919099643,-1.20371318833581,63.1002733968453,-1.24500423164006,58.6086669376940,-1.27116240527829,54.2314419719117,-1.28193765922662,
        -1.33840573963707,0.908638796059456,-1.29485748262506,0.864808998195077,-1.24500423164006,0.834236355013484,-1.18920463669625,0.772025204791733,-1.12807893756717,0.723372750659001,
        66.3125476571606,-1.09415544904128,62.4903172822827,-1.14829796253225,58.6086669376940,-1.18920463669625,54.8221281305324,-1.21608160686221,50.6897841272989,-1.22842659031580,
        -1.36316201940725,0.852630138927331,-1.32024981065877,0.813170573395528,-1.27116240527829,0.772025204791733,-1.21608160686221,0.744227083725989,-1.15539022982237,0.684886154733822,
        61.1432737258708,-1.03610539438811,57.7164088255924,-1.08802173556063,54.2314419719117,-1.12807893756717,50.6897841272989,-1.15539022982237,47.2464959105278,-1.16925302274852,
        -1.37128466681177,0.795564333436141,-1.32958006303327,0.760261613328775,-1.28193765922662,0.723372750659001,-1.22842659031580,0.684886154733822,-1.16925302274852,0.659840469802818;
    
    Eigen::Matrix<double, 50, 10> H;
    H <<0.000847832670271520,2.68589219612251e-06,0,0,0,0,0,0,0,0,
        -0.0122772726989275,0.00294180021408325,0,0,0,0,0,0,0,0,
        0.0116644898562454,3.68136563396310e-05,0.000847832670271520,2.68589219612251e-06,0,0,0,0,0,0,
        -0.0386097119955659,0.0102520493172459,-0.0122772726989275,0.00294180021408325,0,0,0,0,0,0,
        0.0408311486463544,0.000161421562578759,0.0116644898562454,3.68136563396310e-05,0.000847832670271520,2.68589219612251e-06,0,0,0,0,
        -0.0711390836508469,0.0202194626050241,-0.0386097119955659,0.0102520493172459,-0.0122772726989275,0.00294180021408325,0,0,0,0,
        0.0909937998815537,0.000446090613324175,0.0408311486463544,0.000161421562578759,0.0116644898562454,3.68136563396310e-05,0.000847832670271520,2.68589219612251e-06,0,0,
        -0.107247274302697,0.0316894523311459,-0.0711390836508469,0.0202194626050241,-0.0386097119955659,0.0102520493172459,-0.0122772726989275,0.00294180021408325,0,0,
        0.160551944114613,0.000959649968135225,0.0909937998815537,0.000446090613324175,0.0408311486463544,0.000161421562578759,0.0116644898562454,3.68136563396310e-05,0.000847832670271520,2.68589219612251e-06,
        -0.146100709049543,0.0438889554416909,-0.107247274302697,0.0316894523311459,-0.0711390836508469,0.0202194626050241,-0.0386097119955659,0.0102520493172459,-0.0122772726989275,0.00294180021408325,
        0.245674760594926,0.00176395282424102,0.160551944114613,0.000959649968135225,0.0909937998815537,0.000446090613324175,0.0408311486463544,0.000161421562578759,0.0116644898562454,3.68136563396310e-05,
        -0.187127631465075,0.0563063153934249,-0.146100709049543,0.0438889554416909,-0.107247274302697,0.0316894523311459,-0.0711390836508469,0.0202194626050241,-0.0386097119955659,0.0102520493172459,
        0.341893745580489,0.00290995547323024,0.245674760594926,0.00176395282424102,0.160551944114613,0.000959649968135225,0.0909937998815537,0.000446090613324175,0.0408311486463544,0.000161421562578759,
        -0.229574648498202,0.0686086414948411,-0.187127631465075,0.0563063153934249,-0.146100709049543,0.0438889554416909,-0.107247274302697,0.0316894523311459,-0.0711390836508469,0.0202194626050241,
        0.445068394932509,0.00443534548942429,0.341893745580489,0.00290995547323024,0.245674760594926,0.00176395282424102,0.160551944114613,0.000959649968135225,0.0909937998815537,0.000446090613324175,
        -0.272531857420480,0.0805850405614472,-0.229574648498202,0.0686086414948411,-0.187127631465075,0.0563063153934249,-0.146100709049543,0.0438889554416909,-0.107247274302697,0.0316894523311459,
        0.551831122148818,0.00636357814221763,0.445068394932509,0.00443534548942429,0.341893745580489,0.00290995547323024,0.245674760594926,0.00176395282424102,0.160551944114613,0.000959649968135225,
        -0.315085586721202,0.0921077169486941,-0.272531857420480,0.0805850405614472,-0.229574648498202,0.0686086414948411,-0.187127631465075,0.0563063153934249,-0.146100709049543,0.0438889554416909,
        0.659692864529869,0.00870419415721906,0.551831122148818,0.00636357814221763,0.445068394932509,0.00443534548942429,0.341893745580489,0.00290995547323024,0.245674760594926,0.00176395282424102,
        -0.356449699788672,0.103105337879000,-0.315085586721202,0.0921077169486941,-0.272531857420480,0.0805850405614472,-0.229574648498202,0.0686086414948411,-0.187127631465075,0.0563063153934249,
        0.766966998505030,0.0114541601140771,0.659692864529869,0.00870419415721906,0.551831122148818,0.00636357814221763,0.445068394932509,0.00443534548942429,0.341893745580489,0.00290995547323024,
        -0.396034157480968,0.113544759505709,-0.356449699788672,0.103105337879000,-0.315085586721202,0.0921077169486941,-0.272531857420480,0.0805850405614472,-0.229574648498202,0.0686086414948411,
        0.872618882045158,0.0145998834067563,0.766966998505030,0.0114541601140771,0.659692864529869,0.00870419415721906,0.551831122148818,0.00636357814221763,0.445068394932509,0.00443534548942429,
        -0.433457454814929,0.123418429825766,-0.396034157480968,0.113544759505709,-0.356449699788672,0.103105337879000,-0.315085586721202,0.0921077169486941,-0.272531857420480,0.0805850405614472,
        0.976102770598486,0.0181195475921086,0.872618882045158,0.0145998834067563,0.766966998505030,0.0114541601140771,0.659692864529869,0.00870419415721906,0.551831122148818,0.00636357814221763,
        -0.468523621385433,0.132735651174952,-0.433457454814929,0.123418429825766,-0.396034157480968,0.113544759505709,-0.356449699788672,0.103105337879000,-0.315085586721202,0.0921077169486941,
        1.07721591756019,0.0219854705674850,0.976102770598486,0.0181195475921086,0.872618882045158,0.0145998834067563,0.766966998505030,0.0114541601140771,0.659692864529869,0.00870419415721906,
        -0.501183197021436,0.141516485467315,-0.468523621385433,0.132735651174952,-0.433457454814929,0.123418429825766,-0.396034157480968,0.113544759505709,-0.356449699788672,0.103105337879000,
        1.17598058454829,0.0261662733457966,1.07721591756019,0.0219854705674850,0.976102770598486,0.0181195475921086,0.872618882045158,0.0145998834067563,0.766966998505030,0.0114541601140771,
        -0.531491504661128,0.149787490503665,-0.501183197021436,0.141516485467315,-0.468523621385433,0.132735651174952,-0.433457454814929,0.123418429825766,-0.396034157480968,0.113544759505709,
        1.27255477401533,0.0306287340196406,1.17598058454829,0.0261662733457966,1.07721591756019,0.0219854705674850,0.976102770598486,0.0181195475921086,0.872618882045158,0.0145998834067563,
        -0.559571510696112,0.157578743086199,-0.531491504661128,0.149787490503665,-0.501183197021436,0.141516485467315,-0.468523621385433,0.132735651174952,-0.433457454814929,0.123418429825766,
        1.36716816746045,0.0353392742320852,1.27255477401533,0.0306287340196406,1.17598058454829,0.0261662733457966,1.07721591756019,0.0219854705674850,0.976102770598486,0.0181195475921086,
        -0.585584203614125,0.164921778772046,-0.559571510696112,0.157578743086199,-0.531491504661128,0.149787490503665,-0.501183197021436,0.141516485467315,-0.468523621385433,0.132735651174952,
        1.46007841750631,0.0402650783102784,1.36716816746045,0.0353392742320852,1.27255477401533,0.0306287340196406,1.17598058454829,0.0261662733457966,1.07721591756019,0.0219854705674850,
        -0.609706823264482,0.171848191205214,-0.585584203614125,0.164921778772046,-0.559571510696112,0.157578743086199,-0.531491504661128,0.149787490503665,-0.501183197021436,0.141516485467315,
        1.55154301781414,0.0453748785960969,1.46007841750631,0.0402650783102784,1.36716816746045,0.0353392742320852,1.27255477401533,0.0306287340196406,1.17598058454829,0.0261662733457966,
        -0.632117995469305,0.178388708286213,-0.609706823264482,0.171848191205214,-0.585584203614125,0.164921778772046,-0.559571510696112,0.157578743086199,-0.531491504661128,0.149787490503665,
        1.64180260580080,0.0506394578887053,1.55154301781414,0.0453748785960969,1.46007841750631,0.0402650783102784,1.36716816746045,0.0353392742320852,1.27255477401533,0.0306287340196406,
        -0.652988374203946,0.184572612463709,-0.632117995469305,0.178388708286213,-0.609706823264482,0.171848191205214,-0.585584203614125,0.164921778772046,-0.559571510696112,0.157578743086199,
        1.73107232702891,0.0560319256489212,1.64180260580080,0.0506394578887053,1.55154301781414,0.0453748785960969,1.46007841750631,0.0402650783102784,1.36716816746045,0.0353392742320852,
        -0.672475383637925,0.190427407230223,-0.652988374203946,0.184572612463709,-0.632117995469305,0.178388708286213,-0.609706823264482,0.171848191205214,-0.585584203614125,0.164921778772046,
        1.81953863155341,0.0615278227632106,1.73107232702891,0.0560319256489212,1.64180260580080,0.0506394578887053,1.55154301781414,0.0453748785960969,1.46007841750631,0.0402650783102784,
        -0.690720839621239,0.195978656969591,-0.672475383637925,0.190427407230223,-0.652988374203946,0.184572612463709,-0.632117995469305,0.178388708286213,-0.609706823264482,0.171848191205214,
        1.90735951899214,0.0671051034911080,1.81953863155341,0.0615278227632106,1.73107232702891,0.0560319256489212,1.64180260580080,0.0506394578887053,1.55154301781414,0.0453748785960969,
        -0.707850477478470,0.201249945911037,-0.690720839621239,0.195978656969591,-0.672475383637925,0.190427407230223,-0.652988374203946,0.184572612463709,-0.632117995469305,0.178388708286213,
        1.99466678635387,0.0727440350964332,1.90735951899214,0.0671051034911080,1.81953863155341,0.0615278227632106,1.73107232702891,0.0560319256489212,1.64180260580080,0.0506394578887053,
        -0.723974653222238,0.206262916048260,-0.707850477478470,0.201249945911037,-0.690720839621239,0.195978656969591,-0.672475383637925,0.190427407230223,-0.652988374203946,0.184572612463709,
        2.08156926474674,0.0784270471666537,1.99466678635387,0.0727440350964332,1.90735951899214,0.0671051034911080,1.81953863155341,0.0615278227632106,1.73107232702891,0.0560319256489212,
        -0.739189691457854,0.211037354683902,-0.723974653222238,0.206262916048260,-0.707850477478470,0.201249945911037,-0.690720839621239,0.195978656969591,-0.672475383637925,0.190427407230223;

    Eigen::Matrix<double, 50, 11> P; 
    P <<0.00485601327754127,-1.49152800790321,0.0140448421927548,1.78589630143397,2.57805160951824e-05,0.00821246332472763,0.000157075143915874,-0.000281594242563920,1,1,0,
        0.954757272451600,0.973298799436851,-0.0525931731131598,-0.737919241741298,0.0136720164092165,-0.00153066722182538,-0.0217594706699177,0.00404396477760214,0,0,1,
        0.0220668488614970,-4.06818845357543,0.0611030411703361,5.17406742253434,0.000196135038258952,0.0285237191055750,0.0125166770574582,-0.00411397675129900,2,1,0,
        1.86103819703064,2.64811064129595,-0.101128833801735,-1.91772519706210,0.0358487145998505,-0.00568568173944457,-0.0756659310928218,0.0165960838088436,0,0,1,
        0.0569810543193708,-7.50612866512645,0.139897656948512,9.82277595616500,0.000678243199490264,0.0565629554277061,0.0570780749807857,-0.0174014819914279,3,1,0,
        2.71748297924682,4.75030327356917,-0.136509992325488,-3.38158477942955,0.0630351430141622,-0.0113136013163020,-0.154684508122783,0.0394050383015344,0,0,1,
        0.113582952219843,-11.6406050149535,0.236501316740302,15.3374615427342,0.00164840441816634,0.0865010515833160,0.150209473616568,-0.0467175691310488,4,1,0,
        3.52424975554119,7.07691412545326,-0.161623897221359,-5.01739687814672,0.0928814584099198,-0.0172272086390835,-0.251189458229721,0.0733066582562817,0,0,1,
        0.194713389059684,-16.3115683609646,0.334471659277736,21.3484723464360,0.00327197235617470,0.113592066813048,0.299311293511251,-0.0978925665900611,5,1,0,
        4.28251182922573,9.49173636071513,-0.179739908404062,-6.72816056414259,0.123822844729046,-0.0224663141872333,-0.360039806985355,0.118836779043398,0,0,1,
        0.302100741747137,-21.3537731833131,0.420843978597489,27.5523003043023,0.00569124899871212,0.134886818977747,0.502779998656670,-0.175308568581541,6,1,0,
        4.99407284667765,11.9039337972313,-0.192245276011939,-8.42825404376268,0.154831872502709,-0.0263330656301417,-0.477751059520133,0.176326142524257,0,0,1,
        0.436400060622485,-26.6061300740817,0.488074615518613,33.7241294303502,0.00901772824799677,0.149122660241312,0.752573885992861,-0.281739018037582,7,1,0,
        5.66112177686049,14.2503619136103,-0.199264628602326,-10.0473183071502,0.185248191210823,-0.0284195206541556,-0.601345838764689,0.245847460453722,0,0,1,
        0.597303368955893,-31.9244037559706,0.533579160428697,39.7129722354351,0.0133279572612642,0.156297721013838,1.03732139833800,-0.418509588322295,8,1,0,
        6.28608307483581,16.4852545933179,-0.200630199575364,-11.5334500330382,0.214661706646442,-0.0286034452637566,-0.727790071431017,0.327172682488921,0,0,1,
        0.783712943583163,-37.1901193886379,0.558312764216322,45.4286958944608,0.0186628088002791,0.157196308796943,1.34490334924165,-0.585799259726144,9,1,0,
        6.87151789243335,18.5753472102483,-0.196463030357563,-12.8535003952094,0.242832596940994,-0.0270008561215930,-0.853956845444605,0.419781763435409,0,0,1,
        0.993944840395712,-42.3140397126984,0.565265639450763,50.8269820288280,0.0250296872825781,0.152988736305186,1.66416933758827,-0.782965917988094,10,1,0,
        7.42004945535676,20.4977734904397,-0.187334677618252,-13.9909153724540,0.269636515684895,-0.0238914666271670,-0.976844990107135,0.522914139182855,0,0,1,
        1.22593049962744,-47.2351681675344,0.558263054468306,55.8954593627872,0.0324068758945878,0.144944403218930,1.98584307666305,-1.00883622694253,11,1,0,
        7.93430087925082,22.2388887171331,-0.174176769677538,-14.9422700737627,0.295026915417566,-0.0196398950273735,-1.09383297132090,0.635640934040139,0,0,1,
        1.47739442173377,-51.9169879850086,0.541162692894840,60.6423487393019,0.0407491140414612,0.134253111220613,2.30282293216039,-1.26193663910398,12,1,0,
        8.41684242734669,23.7931225442945,-0.158099404834295,-15.7135190373441,0.319008992509637,-0.0146291831929469,-1.20285558380671,0.756938835804371,0,0,1,
        1.74599706653034,-56.3424977585267,0.517400623892620,65.0878704440925,0.0499935715156021,0.121931809664039,2.61010000032378,-1.54066337374677,13,1,0,
        8.87014863848397,25.1616103437251,-0.140217735778015,-16.3166092096439,0.341621555798854,-0.00921394897415801,-1.30247402435774,0.885753986197109,0,0,1,
        2.02944074229967,-60.5091454877880,0.489791587687863,69.2581380614992,0.0600655767991254,0.108790763855814,2.90447424396429,-1.84339901370557,14,1,0,
        9.29656614800654,26.3506695325418,-0.121529181784844,-16.7667534345963,0.362924351613967,-0.00369337963091352,-1.39185515516407,1.02105097560852,0,0,1,
        2.32554159491623,-64.4242986295418,0.460491729449791,73.1810723963077,0.0708836810302027,0.0954366446804753,3.18419384346311,-2.16858662491181,15,1,0,
        9.69829221085840,27.3702821813912,-0.102847629585850,-17.0804233893864,0.382989197332095,0.00169958592327507,-1.47069171959831,1.16184655357267,0,0,1,
        2.63227340356603,-68.1015321746349,0.431052157306513,76.8838514513297,0.0823638427713281,0.0822956376589911,3.44859415446296,-2.51477220562706,16,1,0,
        10.0773629753021,28.2327266126813,-0.0847838776655326,-17.2739897610963,0.401893811638674,0.00679777765052739,-1.53909453635228,1.30723006433750,0,0,1,
        2.94778960243860,-71.5577870157582,0.402514278663674,80.3914702533670,0.0944226764878351,0.0696450760709621,3.69777665293574,-2.88062476287998,17,1,0,
        10.4356498955820,28.9514433507818,-0.0677567889503625,-17.3628838240831,0.419717577497103,0.0114925873878426,-1.59748003774288,1.45637350874454,0,0,1,
        3.27042956182994,-74.8113238175266,0.375516561792505,83.7260654280343,0.106979814380875,0.0576464470406447,3.93234454334264,-3.26494141783698,18,1,0,
        10.7748623994336,29.5401641537401,-0.0520210734961739,-17.3611470533016,0.436538700677333,0.0157236034504106,-1.64646770045947,1.60853414579205,0,0,1,
        3.59871425129559,-77.8803412978657,0.350395787371336,86.9067395267207,0.119959492905029,0.0463757625022015,4.15319755927202,-3.66664313383029,19,1,0,
        11.0965549651671,30.0122920772199,-0.0377013106546914,-17.2812506018467,0.452432377390927,0.0194675324081525,-1.68679457705022,1.76305214113377,0,0,1,
        3.93133533624491,-80.7821145495316,0.327274637674647,89.9496897305680,0.133291502378640,0.0358493956053844,4.36138093425736,-4.08476511916226,20,1,0,
        11.4021369932711,30.3804974705968,-0.0248256097305922,-17.1340898382841,0.467469687707837,0.0227278819416188,-1.71924901250727,1.91934522916356,0,0,1,
        4.26714073133178,-83.5325188335056,0.306132814278297,92.8685022852309,0.146911641402324,0.0260448059366532,4.55798015863538,-4.51844471947919,21,1,0,
        11.6928841728226,30.6564858200929,-0.0133553356621244,-16.9290829047206,0.481717004524606,0.0255261505205393,-1.74462253970765,2.07690182947136,0,0,1,
        4.60511874562153,-86.1458244040197,0.286861893619020,95.6745184021043,0.160761806596775,0.0169163455810756,4.74405225732998,-4.96690866074162,22,1,0,
        11.9699503692107,30.8508935505996,-0.00320941974540284,-16.6743229552462,0.495235761414712,0.0278947793305302,-1.76367738813330,2.23527361133546,0,0,1,
        4.94438223779016,-88.6346709411707,0.269305669066759,98.3772109711845,0.174789829489006,0.00840673592793273,4.92058480038375,-5.42946079316424,23,1,0,
        12.2343793538180,30.9732730818848,0.00571693529417403,-16.3767502986820,0.508082462958116,0.0298718240872850,-1.77712649471554,2.39406814853643,0,0,1,
        5.28415365143625,-91.0101521320885,0.253288367297843,100.984536067638,0.188949151090655,0.000454966046187361,5.08847499256937,-5.90547097518091,24,1,0,
        12.4871159390701,31.0321356452573,0.0135386469040272,-16.0423231956032,0.520308851886003,0.0314971459872121,-1.78562295863585,2.55294204565739,0,0,1,
        5.62375140106397,-93.2819600367994,0.238633240942679,103.503240628187,0.203198403905256,-0.00699861931856868,5.24852256125632,-6.39436538349889,25,1,0,
        12.7290162695402,31.0350277901891,0.0203714215153028,-15.6761751113899,0.531962170965769,0.0328098553900627,-1.78975624203919,2.71159473202662,0,0,1;

    Eigen::Matrix<double, 50, 2> Rs;
    Rs <<1,0,
        0,1,
        1,0,
        0,1,
        1,0,
        0,1,
        1,0,
        0,1,
        1,0,
        0,1,
        1,0,
        0,1,
        1,0,
        0,1,
        1,0,
        0,1,
        1,0,
        0,1,
        1,0,
        0,1,
        1,0,
        0,1,
        1,0,
        0,1,
        1,0,
        0,1,
        1,0,
        0,1,
        1,0,
        0,1,
        1,0,
        0,1,
        1,0,
        0,1,
        1,0,
        0,1,
        1,0,
        0,1,
        1,0,
        0,1,
        1,0,
        0,1,
        1,0,
        0,1,
        1,0,
        0,1,
        1,0,
        0,1,
        1,0,
        0,1;

    Eigen::Matrix<double, 40, 1> dd;
    dd <<1.20000000000000,
        12,
        1.20000000000000,
        12,
        1.20000000000000,
        12,
        1.20000000000000,
        12,
        1.20000000000000,
        12,
        1.20000000000000,
        12,
        1.20000000000000,
        12,
        1.20000000000000,
        12,
        1.20000000000000,
        12,
        1.20000000000000,
        12,
        2,
        13.4487000000000,
        2,
        13.4487000000000,
        2,
        13.4487000000000,
        2,
        13.4487000000000,
        2,
        13.4487000000000,
        2,
        26.5513000000000,
        2,
        26.5513000000000,
        2,
        26.5513000000000,
        2,
        26.5513000000000,
        2,
        26.5513000000000;
    
    Eigen::Matrix<double, 40, 2> dupast;
    dupast <<0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            0.0, 0.0,
            -1.0, 0.0,
            0.0, -1.0,
            -1.0, 0.0,
            0.0, -1.0,
            -1.0, 0.0,
            0.0, -1.0,
            -1.0, 0.0,
            0.0, -1.0,
            -1.0, 0.0,
            0.0, -1.0,
            1.0, 0.0,
            0.0, 1.0,
            1.0, 0.0,
            0.0, 1.0,
            1.0, 0.0,
            0.0, 1.0,
            1.0, 0.0,
            0.0, 1.0,
            1.0, 0.0,
            0.0, 1.0;
            

    Eigen::Matrix<double, 9, 1> x_prev;
    Eigen::Matrix<double, 50, 1> ref;
    Eigen::Matrix<double, 9, 1> x;
    Eigen::Matrix<double, 2, 1> y;
    Eigen::Matrix<double, 2, 1> u;
    Eigen::Matrix<double, 11, 1> Xf;
    Eigen::Matrix<double, 10, 1> F;
    Eigen::Matrix<double, 40, 1> d;
    Eigen::Matrix<double, 10, 1> DeltaU;
    x <<0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0;
    u <<0.0,
        0.0;
    bool MPC_Activate=false;     

    int MPC_P=25;//choose
	float MPC_Ts=0.1;//choose (Setup)
    float gamma=(float)(4*M_PI/180);//From PX4       

    //publish a few values before starting to allow changing into offboard mode
    // for(int i = 100; ros::ok() && i > 0; --i){
    //     // Required for now to allow vehicle to go into offboard mode(CHECK if you can make mpc outputs publish do the same)
    //     local_pos_pub.publish(pose);

    //     //Run callback functions
    //     ros::spinOnce();
    //     //Loop back after 0.02 seconds is over
    //     rate.sleep();
    // }

    // mavros_msgs::SetMode offb_set_mode;
    // offb_set_mode.request.custom_mode = "OFFBOARD";

    // mavros_msgs::CommandBool arm_cmd;
    // arm_cmd.request.value = true;

    ros::Time last_request = ros::Time::now();

    while(ros::ok()){
        // if( current_state.mode != "OFFBOARD" &&
        //     (ros::Time::now() - last_request > ros::Duration(5.0))){
        //     if( set_mode_client.call(offb_set_mode) &&
        //         offb_set_mode.response.mode_sent){
        //         ROS_INFO("Offboard enabled");
        //     }
        //     last_request = ros::Time::now();
        // } else {
        //     if( !current_state.armed &&
        //         (ros::Time::now() - last_request > ros::Duration(5.0))){
        //         if( arming_client.call(arm_cmd) &&
        //             arm_cmd.response.success){
        //             ROS_INFO("Vehicle armed");
        //         }
        //         last_request = ros::Time::now();
        //     }
        // }

        // if( current_state.mode != "OFFBOARD" &&
        //     (ros::Time::now() - last_request > ros::Duration(5.0))){
        //     if( set_mode_client.call(offb_set_mode) &&
        //         offb_set_mode.response.mode_sent){
        //         ROS_INFO("Offboard enabled");
        //     }
        //     last_request = ros::Time::now();
        // }

        // Required for now to allow vehicle to go into offboard mode(CHECK if you can make mpc outputs publish do the same)
        local_pos_pub.publish(pose);

        // if(current_state.mode == "OFFBOARD"){
        if(current_state.connected){    
            
        //MPC reset condition
        // if(MPC_Activate && mpc_ins.state==0){
        if(MPC_Activate && !mpc_ins.mpc_activate){
            std::cout<<"Reset MPC\n";
            MPC_Activate=false;
            // x(0)=0.0;x(1)=0.0;x(2)=0.0;x(3)=0.0;x(4)=0.0;x(5)=0.0;x(6)=0.0;x(7)=0.0;x(8)=0.0;
            // u(0)=0.0;u(1)=0.0;
            x.setZero(9,1);
            u.setZero(2,1);
            // std::cout<<"x : "<<x<<"\n";
        }

        // if(mpc_ins.state>=1){ //Activate when SM is at state 1 or above 
           if(mpc_ins.mpc_activate){ //Activate MPC when controllers run it
            // Run MPC 
            MPC_Activate=true;       
            //Set inputs to MPC

            // for(int i=0;i<60;i++){
            //     MPC_ref[i]=mpc_ins.mpc_ref_in[i];
            //     ref(i)=(double)MPC_ref[i];
            // }

            MPC_ref[0]=mpc_ins.mpc_ref_in[0];
            MPC_ref[1]=mpc_ins.mpc_ref_in[1];
            
            // MPC referance generator
            for(int i=0;i<MPC_P;i++){
		        // if(mpc_ins.state>=2){ //Activate when SM is at state 2 or above
			    if((mpc_ins.ramp_trajectory && MPC_ref[0]>15)||(mpc_ins.mpc_land && mpc_ins.state>=2)){ //Activate ramp trajectory when commanded and above 15m
                    ref(i*2)=MPC_ref[0]+(i)*tan(-gamma)*MPC_Ts*mpc_ins.grd_vel;
			        ref(i*2+1)=MPC_ref[1];
		        }else{
			        ref(i*2)=MPC_ref[0];
			        ref(i*2+1)=MPC_ref[1];
		        }
	        }

            MPC_mo[0]=mpc_ins.mpc_mo_in[0];MPC_mo[1]=mpc_ins.mpc_mo_in[1];
            
            // std::cout<<"MPC_in ref: "<<ref(0)<<" ; "<<ref(1)<<"\n";
            // std::cout<<"MPC_in mo: "<<MPC_mo[0]<<" ; "<<MPC_mo[1]<<"\n";

            Eigen::Matrix<double, 9, 1> x_prev;
            x_prev <<(double)MPC_mo[1],
                    x(1),
                    x(2),
                    x(3),
                    x(4),
                    x(5),
                    x(6),
                    x(7),
                    (double)MPC_mo[0];

            // TESTING
            // std::cout<<"MPC_in ref: "<<mpc_ins.mpc_ref_in[0]<<" ; "<<mpc_ins.mpc_ref_in[37]<<"\n";
            // std::cout<<"MPC_in mo: "<<mpc_ins.mpc_mo_in[0]<<" ; "<<mpc_ins.mpc_mo_in[1]<<"\n";

            // Model predictions
            x = A_MPC_SCR*x_prev + B_MPC_SCR*u;
            y = C_MPC_SCR*x;

            Eigen::Matrix<double, 9, 1> deltax=x-x_prev;
            Eigen::Matrix<double, 11, 1> Xf;
            Xf <<deltax(0),
                deltax(1),
                deltax(2),
                deltax(3),
                deltax(4),
                deltax(5),
                deltax(6),
                deltax(7),
                deltax(8),
                y(0),
                y(1);

            F=-2*H.transpose()*(ref-P*Xf);

            d = dd + dupast*u;

            DeltaU=QPhild(E, F, CC, d);

            Eigen::Matrix<double, 5, 2> DeltaU_1;
            DeltaU_1 <<DeltaU(0,0), DeltaU(1,0),
                       DeltaU(2,0), DeltaU(3,0),
                       DeltaU(4,0), DeltaU(5,0),
                       DeltaU(6,0), DeltaU(7,0),
                       DeltaU(8,0), DeltaU(9,0);

            Eigen::Matrix<double, 1, 2> deltau= DeltaU_1.row(0);

            u = u + deltau.transpose();            

            mpc_outs.mpc_mv_out[0]=(float)u(0);
            mpc_outs.mpc_mv_out[1]=(float)u(1);
            //!!!ADD publish to topic!!!
            mpc_outputs_pub.publish(mpc_outs);
        }
        //!!!TESTING!!!
        // std::cout<< "MPC_mv : " << MPC_mv[0] <<" ; " << MPC_mv[1]<<"\n";
        // std_msgs::String msg_out;
        // std::stringstream ss;
        // ss << "MPC_mv : " << MPC_mv[0] <<" ; " << MPC_mv[1];
        // msg_out.data = ss.str();
        // ROS_INFO("%s", msg_out.data.c_str());
        
        // }

        }

        ros::spinOnce();
        rate.sleep();
    }
    //Teminate MPC
    // MPC0_terminate();

    return 0;
}

